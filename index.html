<!doctype html>

<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JLPT N1 読解SRS（大量記憶表・日付塗りつぶし）</title>
  <style>
    :root{
      --bg:#0c0f13; --card:#12161c; --ink:#e9eef4; --muted:#a6b0bb; --line:#222830;
      --accent:#57b1ff; --done:#2dd4bf; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:"Meiryo UI", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; background:linear-gradient(180deg,#0c0f13 0%,#0e1217 100%); color:var(--ink)}
    .wrap{max-width:1100px; margin:0 auto; padding:14px}
    header{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{font-size:20px; margin:6px 0}
    .sub{color:var(--muted); font-size:13px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.22); margin-top:10px}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:4px}
    input{width:100%; padding:10px 12px; background:#0e1217; color:var(--ink); border:1px solid var(--line); border-radius:10px}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .btn{appearance:none; border:none; background:var(--accent); color:#04121d; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer}
    .btn.ghost{background:transparent; color:var(--ink); border:1px solid var(--line)}
    .btn.warn{background:var(--warn); color:#241b00}
    .btn.small{padding:6px 10px; border-radius:10px; font-size:12px}
    .chip{font-size:11px; padding:4px 8px; border-radius:999px; background:#0e1217; border:1px solid var(--line); color:var(--muted)}.grid{display:grid; gap:10px}
.grid.cols-3{grid-template-columns:1fr}
@media(min-width:900px){.grid.cols-3{grid-template-columns:1.2fr 1fr 1fr}}

.tableWrap{overflow:auto; border:1px solid var(--line); border-radius:12px}
table{border-collapse:separate; border-spacing:0; width:100%; font-size:13px}
th,td{border-bottom:1px solid var(--line); border-right:1px solid var(--line); padding:8px 6px; text-align:left; white-space:nowrap}
th:last-child, td:last-child{border-right:none}
thead th{position:sticky; top:0; background:#0f141b; z-index:2}
tbody th{position:sticky; left:0; background:#0f141b; z-index:1}
.cell{min-width:76px; text-align:center; border-radius:8px; cursor:pointer; user-select:none}
.cell.done{background:var(--done); color:#04121d; font-weight:700}
.cell.past:not(.done){opacity:.45}
.cell.today{outline:2px solid #457bff; outline-offset:-2px}
.hint{color:var(--muted); font-size:12px}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>JLPT N1 読解SRS（塗りつぶし表）</h1>
        <div class="sub">あなたは「日付セルをタップして塗る」だけ。項目名・見出し・番号は自動生成します。</div>
      </div>
      <div class="row">
        <span class="chip" id="todayChip">今日: -</span>
        <span class="chip" id="examChip">試験日: -</span>
      </div>
    </header><section class="card">
  <div class="grid cols-3">
    <div>
      <label>開始日</label>
      <input type="date" id="startDate"/>
    </div>
    <div>
      <label>試験日</label>
      <input type="date" id="examDate"/>
    </div>
    <div>
      <label>復習間隔（固定）</label>
      <div class="chip">0.5 / 1 / 2 / 4 / 7 / 14 / 21 / 28（日）</div>
    </div>
  </div>
  <div class="row" style="margin-top:8px">
    <button class="btn" id="genBtn">スケジュール自動生成（上書き）</button>
    <button class="btn ghost" id="todayOnlyBtn">今日だけ表示/解除</button>
    <button class="btn warn" id="clearMarksBtn">塗りつぶしを全て消す</button>
  </div>
  <div class="hint">※ 自動生成は行（項目）を上書きします（塗りつぶしは保持）。</div>
</section>

<section class="card">
  <h3 style="margin:0 0 8px">今日のタスク</h3>
  <div id="todayList" class="row" style="gap:6px; flex-wrap:wrap"></div>
</section>

<section class="card">
  <div class="tableWrap">
    <table id="grid">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="hint" style="margin-top:6px">セルをタップ/クリックで塗りつぶし（もう一度で解除）。</div>
</section>

  </div><script>
(function(){
  const STORAGE_KEY = 'jlptn1_simple_srs_v2';
  const $ = s=>document.querySelector(s);

  // ====== dates ======
  function startOfDay(d){const x=new Date(d);x.setHours(0,0,0,0);return x}
  function addDays(d,days){const x=new Date(d);x.setDate(x.getDate()+Math.floor(days));return x}
  function addFracDaysAsDate(d,days){ return days<1? startOfDay(d) : addDays(d,days); }
  function fmt(d){const m=d.getMonth()+1;const dd=d.getDate();return `${m}/${dd}`}
  function toInput(d){ const z=new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
  function fromInput(s){ return startOfDay(new Date(s)); }
  function firstSundayOfDecember(year){const d=new Date(year,11,1);while(d.getDay()!==0)d.setDate(d.getDate()+1);return startOfDay(d)}
  function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}

  const today = startOfDay(new Date());
  $('#todayChip').textContent = `今日: ${fmt(today)}`;

  // defaults
  const defExam = firstSundayOfDecember(new Date().getFullYear());
  $('#startDate').value = toInput(today);
  $('#examDate').value = toInput(defExam);
  $('#examChip').textContent = `試験日: ${fmt(defExam)}`;

  // model
  let db = load() || { start: toInput(today), exam: toInput(defExam), rows: [], marks:{} };
  $('#startDate').value = db.start;
  $('#examDate').value = db.exam;
  $('#examChip').textContent = `試験日: ${fmt(fromInput(db.exam))}`;

  const INTERVALS = [0.5,1,2,4,7,14,21,28];
  const state = { todayOnly:false };

  // events
  $('#genBtn').addEventListener('click', regenerate);
  $('#todayOnlyBtn').addEventListener('click', ()=>{ state.todayOnly=!state.todayOnly; render(); });
  $('#clearMarksBtn').addEventListener('click', ()=>{ if(confirm('全ての塗りつぶしを消しますか？')){ db.marks={}; save(); render(); }});
  $('#startDate').addEventListener('change', ()=>{ db.start=$('#startDate').value; save(); });
  $('#examDate').addEventListener('change', ()=>{ db.exam=$('#examDate').value; save(); $('#examChip').textContent=`試験日: ${fmt(fromInput(db.exam))}`; });

  // initial draw
  if(!db.rows.length) regenerate(); else render();

  // ====== generation ======
  function regenerate(){
    const start = fromInput($('#startDate').value||db.start);
    const exam = fromInput($('#examDate').value||db.exam);
    if(!(start<exam)) { alert('開始日が試験日より前である必要があります'); return; }

    const prevMarks = db.marks || {};
    const rows = [];
    const counters = {INF:0,LON:0,CHT:0,SUM:0,REF:0,DRL:0,SIM:0};

    for(let d=new Date(start); d<exam; d.setDate(d.getDate()+1)){
      const weekday = d.getDay();
      const code = weekday===0? 'SIM' : (weekday===6? 'DRL' : ['INF','LON','CHT','SUM','REF'][weekday-1]);
      counters[code]++;
      const title = buildTitle(d, code, counters[code], start);
      const dates = INTERVALS.map(k=> addFracDaysAsDate(d,k));
      const due = dates.filter(dd=> dd<=exam);
      rows.push({ id: genId('RD'), base: toInput(d), title, code, due: due.map(x=>toInput(x)) });
    }

    db.rows = rows; db.start = toInput(start); db.exam = toInput(exam); db.marks = prevMarks;
    save(); render();
  }

  function buildTitle(date, code, num, start){
    const week = weekNumber(start, date);
    const name = { INF:'情報検索・実用文', LON:'論説：主張と根拠', CHT:'図表・データ読解', SUM:'要約・空所補充', REF:'指示語・参照関係', DRL:'弱点ドリル', SIM:'模試/通し（軽）' }[code];
    const n = (''+num).padStart(2,'0');
    return `W${week}-${code}${n} ${name}`;
  }
  function weekNumber(start, date){ const ms = startOfDay(date)-startOfDay(start); return Math.floor(ms/(7*24*3600*1000)) + 1; }

  // ====== render ======
  function render(){
    const thead = document.querySelector('#grid thead');
    const tbody = document.querySelector('#grid tbody');
    thead.innerHTML=''; tbody.innerHTML='';

    const tr = document.createElement('tr');
    tr.innerHTML = `<th>週/タイトル</th><th>基準日</th>${INTERVALS.map(i=>`<th>${i===0.5?'0.5':i}</th>`).join('')}`;
    thead.appendChild(tr);

    const start = fromInput(db.start); const exam = fromInput(db.exam);
    const tBox = $('#todayList'); tBox.innerHTML='';

    const rows = (db.rows||[]).filter(r=> r.due.length>0);
    for(const row of rows){
      const hasToday = row.due.some(dd=> sameDay(fromInput(dd), today));
      if(state.todayOnly && !hasToday) continue;

      const trb = document.createElement('tr');
      trb.appendChild(th(`${escapeHtml(row.title)}`));
      trb.appendChild(td(fmt(fromInput(row.base))));

      INTERVALS.forEach((ival, idx)=>{
        const d = addFracDaysAsDate(fromInput(row.base), ival);
        let cell = td('-');
        if(d<=exam){
          const key = markKey(row.id, toInput(d), idx);
          const marked = !!db.marks[key];
          const isToday = sameDay(d, today);
          const past = d<today;
          cell = td(fmt(d));
          cell.className = 'cell' + (marked?' done':'') + (past&&!marked?' past':'') + (isToday?' today':'');
          cell.dataset.key = key;
          if(isToday){
            const b = document.createElement('button');
            b.className='btn small' + (marked?' ghost':'');
            b.textContent = `${row.title}  #${ival===0.5?'0.5':ival}`;
            b.addEventListener('click', ()=> toggleMark(key));
            tBox.appendChild(b);
          }
        }
        trb.appendChild(cell);
      });
      tbody.appendChild(trb);
    }

    // delegate cell clicks
    tbody.querySelectorAll('.cell').forEach(el=>{
      el.addEventListener('click', e=>{
        const key = e.currentTarget.dataset.key; if(!key) return; toggleMark(key);
      });
    });
  }

  function th(html){ const e=document.createElement('th'); e.innerHTML=html; return e }
  function td(text){ const e=document.createElement('td'); e.textContent=text; return e }

  function toggleMark(key){ db.marks[key] = !db.marks[key]; save(); render(); }
  function markKey(id, dateStr, stepIdx){ return `${id}|${dateStr}|${stepIdx}`; }

  // ====== storage & utils ======
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||''); }catch(_){ return null; } }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function genId(prefix){ return `${prefix}-${Math.random().toString(36).slice(2,7)}-${Date.now().toString(36).slice(-4)}` }
})();
</script></body>
</html>th,td{border-bottom:1px solid var(--line); border-right:1px solid var(--line); padding:8px 6px; text-align:left; white-space:nowrap}
th:last-child, td:last-child{border-right:none}
thead th{position:sticky; top:0; background:#0f141b; z-index:2}
tbody th{position:sticky; left:0; background:#0f141b; z-index:1}
tbody th.group{background:#0d1218; color:var(--muted); font-weight:600}
.cell{min-width:76px; text-align:center; border-radius:8px; cursor:pointer; user-select:none}
.cell.done{background:var(--done); color:#04121d; font-weight:700}
.cell.past:not(.done){opacity:.45}
.cell.today{outline:2px solid #457bff; outline-offset:-2px}
.hint{color:var(--muted); font-size:12px}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>JLPT N1 読解SRS（塗りつぶし表）</h1>
        <div class="sub">あなたは「日付セルをタップして塗る」だけ。項目名・見出し・番号は自動生成します。</div>
      </div>
      <div class="row">
        <span class="chip" id="todayChip">今日: -</span>
        <span class="chip" id="examChip">試験日: -</span>
      </div>
    </header><section class="card">
  <div class="grid cols-3">
    <div>
      <label>開始日</label>
      <input type="date" id="startDate"/>
    </div>
    <div>
      <label>試験日</label>
      <input type="date" id="examDate"/>
    </div>
    <div>
      <label>復習間隔（固定）</label>
      <div class="chip">0.5 / 1 / 2 / 4 / 7 / 14 / 21 / 28（日）</div>
    </div>
  </div>
  <div class="row" style="margin-top:8px">
    <button class="btn" id="genBtn">スケジュール自動生成（上書き）</button>
    <button class="btn ghost" id="todayOnlyBtn">今日だけ表示/解除</button>
    <button class="btn warn" id="clearMarksBtn">塗りつぶしを全て消す</button>
  </div>
  <div class="hint">※ 自動生成すると既存の行は上書きされます（塗りつぶしは保持します）。</div>
</section>

<section class="card">
  <h3 style="margin:0 0 8px">今日のタスク</h3>
  <div id="todayList" class="row" style="gap:6px; flex-wrap:wrap"></div>
</section>

<section class="card">
  <div class="tableWrap">
    <table id="grid">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="hint" style="margin-top:6px">セルをタップ/クリックで塗りつぶし（もう一度で解除）。</div>
</section>

  </div><script>
(function(){
  const STORAGE_KEY = 'jlptn1_simple_srs_v1';
  const $ = s=>document.querySelector(s);

  // ====== dates ======
  function startOfDay(d){const x=new Date(d);x.setHours(0,0,0,0);return x}
  function addDays(d,days){const x=new Date(d);x.setDate(x.getDate()+Math.floor(days));return x}
  function addFracDaysAsDate(d,days){ // 0.5日は同日扱い
    return days<1? startOfDay(d) : addDays(d,days);
  }
  function fmt(d){const m=d.getMonth()+1;const dd=d.getDate();return `${m}/${dd}`}
  function toInput(d){ const z=new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
  function fromInput(s){ return startOfDay(new Date(s)); }
  function firstSundayOfDecember(year){const d=new Date(year,11,1);while(d.getDay()!==0)d.setDate(d.getDate()+1);return startOfDay(d)}
  function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}

  const today = startOfDay(new Date());
  $('#todayChip').textContent = `今日: ${fmt(today)}`;

  // defaults
  const defExam = firstSundayOfDecember(new Date().getFullYear());
  $('#startDate').value = toInput(today);
  $('#examDate').value = toInput(defExam);
  $('#examChip').textContent = `試験日: ${fmt(defExam)}`;

  // model
  let db = load() || { start: toInput(today), exam: toInput(defExam), rows: [], marks:{} };
  $('#startDate').value = db.start;
  $('#examDate').value = db.exam;
  $('#examChip').textContent = `試験日: ${fmt(fromInput(db.exam))}`;

  const INTERVALS = [0.5,1,2,4,7,14,21,28];

  // events
  $('#genBtn').addEventListener('click', regenerate);
  $('#todayOnlyBtn').addEventListener('click', ()=>{ state.todayOnly=!state.todayOnly; render(); });
  $('#clearMarksBtn').addEventListener('click', ()=>{ if(confirm('全ての塗りつぶしを消しますか？')){ db.marks={}; save(); render(); }});
  $('#startDate').addEventListener('change', ()=>{ db.start=$('#startDate').value; save(); });
  $('#examDate').addEventListener('change', ()=>{ db.exam=$('#examDate').value; save(); $('#examChip').textContent=`試験日: ${fmt(fromInput(db.exam))}`; });

  const state = { todayOnly:false };

  // initial draw
  if(!db.rows.length) regenerate(); else render();

  // ====== generation ======
  function regenerate(){
    const start = fromInput($('#startDate').value||db.start);
    const exam = fromInput($('#examDate').value||db.exam);
    if(!(start<exam)) { alert('開始日が試験日より前である必要があります'); return; }

    // keep old marks
    const prevMarks = db.marks || {};

    const rows = [];
    const counters = {INF:0,LON:0,CHT:0,SUM:0,REF:0,DRL:0,SIM:0};

    for(let d=new Date(start); d<exam; d.setDate(d.getDate()+1)){
      const weekday = d.getDay();
      const code = weekday===0? 'SIM' : (weekday===6? 'DRL' : ['INF','LON','CHT','SUM','REF'][weekday-1]);
      counters[code]++;
      const title = buildTitle(d, code, counters[code]);

      const dates = INTERVALS.map(k=> addFracDaysAsDate(d,k));
      const due = dates.filter(dd=> dd<=exam);

      rows.push({ id: genId('RD'), base: toInput(d), title, code, due: due.map(x=>toInput(x)) });
    }

    db.rows = rows;
    db.start = toInput(start); db.exam = toInput(exam);
    db.marks = prevMarks; // keep
    save();
    render();
  }

  function buildTitle(date, code, num){
    const week = weekNumber(fromInput(db.start||toInput(today)), date);
    const name = {
      INF:'情報検索・実用文', LON:'論説：主張と根拠', CHT:'図表・データ読解', SUM:'要約・空所補充', REF:'指示語・参照関係', DRL:'弱点ドリル', SIM:'模試/通し（軽）'
    }[code];
    const n = (''+num).padStart(2,'0');
    return `W${week}-${code}${n} ${name}`;
  }
  function weekNumber(start, date){ // start-based week (1-index)
    const ms = startOfDay(date)-startOfDay(start);
    return Math.floor(ms/ (7*24*3600*1000)) + 1;
  }

  // ====== render ======
  function render(){
    const thead = document.querySelector('#grid thead');
    const tbody = document.querySelector('#grid tbody');
    thead.innerHTML=''; tbody.innerHTML='';

    // header
    const tr = document.createElement('tr');
    tr.innerHTML = `<th>週/タイトル</th><th>基準日</th>${INTERVALS.map(i=>`<th>${i===0.5?'0.5':i}</th>`).join('')}`;
    thead.appendChild(tr);

    const start = fromInput(db.start); const exam = fromInput(db.exam);

    // today list
    const tBox = $('#todayList'); tBox.innerHTML='';

    const rows = (db.rows||[]).filter(r=> r.due.length>0);
    for(const row of rows){
      // filter: today only mode => only render rows that have a today due
      const hasToday = row.due.some(dd=> sameDay(fromInput(dd), today));
      if(state.todayOnly && !hasToday) continue;

      const trb = document.createElement('tr');
      trb.innerHTML = `<th>${escapeHtml(row.title)}</th><td>${fmt(fromInput(row.base))}</td>`;

      INTERVALS.forEach((ival, idx)=>{
        const d = addFracDaysAsDate(fromInput(row.base), ival);
        if(d>exam){ trb.innerHTML += `<td class="cell past">-</td>`; return; }
        const key = markKey(row.id, toInput(d), idx);
        const marked = !!db.marks[key];
        const isToday = sameDay(d, today);
        const past = d<today;
        const cls = ['cell'];
        if(marked) cls.push('done');
        if(past && !marked) cls.push('past');
        if(isToday) cls.push('today');
        trb.innerHTML += `<td class="${cls.join(' ')}" data-key="${key}" title="${fmt(d)}">${fmt(d)}</td>`;

        // today list card
        if(isToday){
          const btn = document.createElement('button');
          btn.className='btn small';
          btn.textContent = `${row.title}  #${ival===0.5?'0.5':ival}`;
          if(marked){ btn.classList.add('ghost'); }
          btn.addEventListener('click', ()=> toggleMark(key));
          tBox.appendChild(btn);
        }
      });
      tbody.appendChild(trb);
    }

    // cell interactivity
    document.querySelectorAll('.cell').forEach(td=>{
      const key = td.getAttribute('data-key'); if(!key) return;
      td.addEventListener('click', ()=> toggleMark(key));
    });
  }

  function toggleMark(key){ db.marks[key] = !db.marks[key]; save(); render(); }

  function markKey(id, dateStr, stepIdx){ return `${id}|${dateStr}|${stepIdx}`; }

  // ====== storage & utils ======
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||''); }catch(_){ return null; } }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function genId(prefix){ return `${prefix}-${Math.random().toString(36).slice(2,7)}-${Date.now().toString(36).slice(-4)}` }
})();
</script></body>
</html>    .grid.cols-3{grid-template-columns:1fr}
    @media(min-width:800px){.grid.cols-2{grid-template-columns:1fr 1fr}.grid.cols-3{grid-template-columns:2fr 1fr 1fr}}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:4px}
    input, select, textarea{width:100%; box-sizing:border-box; padding:10px 12px; background:#0f1115; color:var(--ink); border:1px solid var(--line); border-radius:10px; outline:none}
    input[type="date"]{padding:8px 10px}
    textarea{min-height:84px; resize:vertical}
    .btn{appearance:none; border:none; background:var(--brand); color:#00151b; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.ghost{background:transparent; color:var(--ink); border:1px solid var(--line)}
    .btn.warn{background:var(--warn); color:#1a1300}
    .btn.danger{background:var(--danger); color:white}
    .btn.small{padding:6px 10px; border-radius:10px; font-size:12px}
    .chip{font-size:11px; padding:4px 8px; border-radius:999px; background:#0f1115; border:1px solid var(--line); color:var(--muted)}
    .chip.good{background:rgba(94,211,141,.15); border-color:rgba(94,211,141,.35); color:#a7f3c4}
    .chip.bad{background:rgba(255,107,107,.14); border-color:rgba(255,107,107,.36); color:#ffb3b3}
    .chip.mid{background:rgba(255,209,102,.12); border-color:rgba(255,209,102,.34); color:#ffe7b2}
    .kpi{display:flex; gap:8px; align-items:center}
    .kpi strong{font-size:22px}
    .list{display:flex; flex-direction:column; gap:8px;}
    .item{display:flex; flex-direction:column; gap:6px; padding:10px; border:1px dashed var(--line); border-radius:12px; background:#101419}
    .item .head{display:flex; justify-content:space-between; gap:8px; align-items:center}
    .item .title{font-weight:700}
    .item .meta{color:var(--muted); font-size:12px; display:flex; gap:8px; flex-wrap:wrap}
    .rowBtns{display:flex; gap:6px; flex-wrap:wrap}
    .muted{color:var(--muted)}
    .hr{height:1px; background:var(--line); margin:12px 0}
    .table{width:100%; border-collapse:collapse; font-size:13px}
    .table th,.table td{border-bottom:1px solid var(--line); padding:8px 6px; text-align:left}
    .table th{color:var(--muted); font-weight:600}
    .pill{display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:#0f1115; font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .footer{color:var(--muted); font-size:11px; text-align:center; margin:20px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>JLPT N1 読解SRSプランナー</h1>
        <div class="sub">読解を主軸に、0.5/1/2/4/7/14/21…日の復習を自動で並べます（ローカル保存）。</div>
      </div>
      <div class="kpi">
        <span class="chip" id="examChip">試験日: -</span>
        <span class="chip" id="todayChip">今日: -</span>
      </div>
    </header><div class="grid cols-3">
  <!-- 作成カード -->
  <section class="card">
    <h2>新規アイテムを追加</h2>
    <div class="grid cols-2">
      <div>
        <label>学習対象（例：長文セットA／語彙#001-030）</label>
        <input id="title" placeholder="タイトルを入力"/>
      </div>
      <div>
        <label>種別</label>
        <select id="kind">
          <option value="読解">読解</option>
          <option value="語彙">語彙</option>
          <option value="文法">文法</option>
          <option value="聴解">聴解</option>
          <option value="その他">その他</option>
        </select>
      </div>
      <div>
        <label>学習日（基準日）</label>
        <input type="date" id="baseDate" />
      </div>
      <div>
        <label>SRSテンプレート</label>
        <select id="template">
          <option value="std">標準：0.5,1,2,4,7,14,21,28</option>
          <option value="long">長期：0.5,1,2,4,7,14,21,30,45,60</option>
          <option value="short">短期：0.5,1,2,4,7,10</option>
          <option value="custom">カスタム（下段に入力）</option>
        </select>
      </div>
      <div>
        <label>カスタム間隔（日,カンマ区切り／0.5可）</label>
        <input id="customIntervals" placeholder="例: 0.5,1,2,4,7,14"/>
      </div>
      <div>
        <label>メモ（任意）</label>
        <input id="notes" placeholder="例：主張/反論の型を意識"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="addBtn">＋ 追加</button>
      <button class="btn ghost" id="quickReadBtn">読解 今日の型を追加</button>
    </div>
  </section>

  <!-- 今日やること -->
  <section class="card">
    <h2>今日のやること</h2>
    <div id="todayList" class="list"></div>
    <div class="hr"></div>
    <div class="row">
      <button class="btn ghost small" id="clearTodayBtn">完了済を非表示</button>
      <button class="btn warn small" id="addBoosterBtn">△/×の明日ブーストを一括追加</button>
    </div>
  </section>

  <!-- 近日の予定 -->
  <section class="card">
    <h2>近日（7日）</h2>
    <table class="table" id="upcomingTbl">
      <thead>
        <tr><th>日付</th><th>対象</th><th>段階</th><th>操作</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- アイテム一覧 -->
  <section class="card" style="grid-column:1/-1">
    <h2>アイテム一覧</h2>
    <div class="row" style="margin-bottom:8px">
      <button class="btn ghost small" id="exportBtn">JSONエクスポート</button>
      <label class="pill">
        <input type="file" id="importFile" accept="application/json" style="display:none" />
        <span style="cursor:pointer" id="importLbl">JSONインポート</span>
      </label>
      <button class="btn danger small" id="resetBtn">全データ削除</button>
    </div>
    <div id="itemsList" class="list"></div>
  </section>

  <!-- 設定 -->
  <section class="card" style="grid-column:1/-1">
    <h2>設定</h2>
    <div class="grid cols-3">
      <div>
        <label>試験日</label>
        <input type="date" id="examDate" />
      </div>
      <div>
        <label>表示：読解の根拠1行メモ（デフォルトON）</label>
        <select id="oneLinePref">
          <option value="on">ON</option>
          <option value="off">OFF</option>
        </select>
      </div>
      <div>
        <label>日時フォーマット</label>
        <select id="fmtPref">
          <option value="ymd">YYYY-MM-DD</option>
          <option value="md">M/D</option>
        </select>
      </div>
    </div>
  </section>
</div>

<div class="footer">保存はブラウザのローカルストレージ。GitHub Pagesにそのまま置けます（index.html 単体）。</div>

  </div><script>
(function(){
  const STORAGE_KEY = 'jlptn1_srs_v1';
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const today = startOfDay(new Date());
  $('#todayChip').textContent = `今日: ${fmtDate(today)}`;

  // === 試験日の初期値：今年12月の第1日曜日 ===
  const defaultExam = firstSundayOfDecember(new Date().getFullYear());
  $('#examDate').value = toInputDate(defaultExam);
  $('#examChip').textContent = `試験日: ${fmtDate(defaultExam)}`;

  // === 入力初期値 ===
  $('#baseDate').value = toInputDate(today);

  // === データモデル ===
  let db = load() || { exam: toISO(defaultExam), items: [], prefs: {oneLine:'on', fmt:'ymd'} };
  applyPrefs();

  // --- UIイベント ---
  $('#addBtn').addEventListener('click', onAdd);
  $('#quickReadBtn').addEventListener('click', addQuickRead);
  $('#examDate').addEventListener('change', () => {
    db.exam = toISO(new Date($('#examDate').value));
    save();
    $('#examChip').textContent = `試験日: ${fmtDate(new Date(db.exam))}`;
    renderAll();
  });
  $('#oneLinePref').addEventListener('change', (e)=>{ db.prefs.oneLine = e.target.value; save(); renderAll(); });
  $('#fmtPref').addEventListener('change', (e)=>{ db.prefs.fmt = e.target.value; save(); renderAll(); });
  $('#template').addEventListener('change', ()=>{
    if($('#template').value==='custom') $('#customIntervals').focus();
  });
  $('#clearTodayBtn').addEventListener('click', ()=>{ hideDoneToday = !hideDoneToday; renderToday(); });
  $('#addBoosterBtn').addEventListener('click', addBoostersForWeak);
  $('#exportBtn').addEventListener('click', onExport);
  $('#importLbl').addEventListener('click', ()=> $('#importFile').click());
  $('#importFile').addEventListener('change', onImport);
  $('#resetBtn').addEventListener('click', onReset);

  // 描画
  renderAll();

  // ===== 関数群 =====
  function onAdd(){
    const title = $('#title').value.trim();
    if(!title){ alert('タイトルを入力してください'); return; }
    const kind = $('#kind').value;
    const baseDate = new Date($('#baseDate').value || toInputDate(today));
    const tmpl = $('#template').value;
    const notes = $('#notes').value.trim();

    let intervals = getIntervalsByTemplate(tmpl, $('#customIntervals').value.trim());
    const exam = new Date(db.exam);
    const id = genId('ITM');
    const sessions = buildSessions(baseDate, intervals, exam);
    if(!sessions.length){ alert('試験日までに収まる復習がありません。間隔を見直してください。'); return; }

    db.items.unshift({ id, title, kind, base: toISO(baseDate), intervals, sessions, notes });
    save();
    clearInputs();
    renderAll();
  }

  function addQuickRead(){
    // 読解 1セット（今日）を素早く登録
    $('#title').value = `読解セット ${dateCode(today)}`;
    $('#kind').value = '読解';
    $('#baseDate').value = toInputDate(today);
    $('#template').value = 'std';
    $('#customIntervals').value = '';
    $('#notes').value = '設問先読み→段落役割→根拠1行固定';
  }

  function addBoostersForWeak(){
    const tmr = addDays(today, 1);
    let added = 0;
    db.items.forEach(it => {
      it.sessions.forEach(s => {
        if(s.result==='△' || s.result==='×'){
          // 既に同日予定があるかチェック
          const exists = it.sessions.some(x=> sameDay(new Date(x.due), tmr) && x.tag==='booster' && x.baseStep===s.step);
          if(!exists){
            it.sessions.push({ step: s.step, due: toISO(tmr), status:'pending', tag:'booster', baseStep:s.step, result:null });
            added++;
          }
        }
      });
    });
    if(added>0){ save(); renderAll(); alert(`ブーストを ${added} 件 追加しました（明日）。`); }
    else alert('△/×の項目が見つかりませんでした。');
  }

  function buildSessions(baseDate, intervals, exam){
    const out = [];
    for(let i=0;i<intervals.length;i++){
      const d = addDays(baseDate, intervals[i]);
      if(d>exam) break; // 試験日以降は切り捨て
      out.push({ step:i+1, due:toISO(d), status:'pending', result:null });
    }
    // 0.5日の「当日夜」復習
    if(intervals[0]!==0.5){
      const half = addDays(baseDate, 0.5);
      if(half<=exam) out.unshift({ step:0, due:toISO(half), status:'pending', tag:'0.5', result:null });
    }
    return out;
  }

  function getIntervalsByTemplate(tmpl, custom){
    if(tmpl==='std') return [0.5,1,2,4,7,14,21,28];
    if(tmpl==='long') return [0.5,1,2,4,7,14,21,30,45,60];
    if(tmpl==='short') return [0.5,1,2,4,7,10];
    // custom
    const nums = custom.split(',').map(s=>parseFloat(s.trim())).filter(n=>!isNaN(n) && n>0);
    return nums.length? nums : [0.5,1,2,4,7,14];
  }

  function renderAll(){
    renderToday();
    renderUpcoming();
    renderItems();
    $('#oneLinePref').value = db.prefs.oneLine||'on';
    $('#fmtPref').value = db.prefs.fmt||'ymd';
    $('#examDate').value = toInputDate(new Date(db.exam));
  }

  let hideDoneToday = false;
  function renderToday(){
    const box = $('#todayList');
    box.innerHTML='';
    const list = collectDueOn(today);
    if(list.length===0){ box.innerHTML = '<div class="muted">本日予定の復習はありません。</div>'; return; }
    list.forEach(row => {
      if(hideDoneToday && row.session.status==='done') return;
      const div = document.createElement('div');
      div.className='item';
      const title = `${row.item.title}`;
      const stepLabel = row.session.tag==='0.5' ? '0.5' : `#${row.session.step}`;
      div.innerHTML = `
        <div class="head">
          <div class="title">${escapeHtml(title)} <span class="chip">${row.item.kind}</span></div>
          <div class="rowBtns">
            ${renderResultButtons(row)}
          </div>
        </div>
        <div class="meta">
          <span>段階: <span class="mono">${stepLabel}</span></span>
          <span>基準日: ${fmtDate(new Date(row.item.base))}</span>
          ${ row.session.tag==='booster' ? '<span class="chip mid">ブースト</span>' : ''}
          ${ row.session.status==='done' ? '<span class="chip good">完了</span>' : ''}
        </div>
      `;
      box.appendChild(div);
    });
  }

  function renderResultButtons(row){
    const s = row.session;
    const disabled = s.status==='done' ? 'disabled' : '';
    const mark = (symbol) => `mark('${row.item.id}','${toISO(new Date(s.due))}','${symbol}')`;
    return `
      <button class="btn small" ${disabled} onclick="${mark('○')}">○ 正解</button>
      <button class="btn warn small" ${disabled} onclick="`${mark('△')}`">△ 曖昧</button>
      <button class="btn danger small" ${disabled} onclick="${mark('×')}">× 誤答</button>
    `;
  }

  function renderUpcoming(){
    const tbody = $('#upcomingTbl tbody');
    tbody.innerHTML='';
    const next7 = collectUpcoming(today, 7);
    next7.forEach(r => {
      const tr = document.createElement('tr');
      const stepLabel = r.session.tag==='0.5' ? '0.5' : `#${r.session.step}`;
      tr.innerHTML = `
        <td>${fmtDate(new Date(r.session.due))}</td>
        <td>${escapeHtml(r.item.title)} <span class="chip">${r.item.kind}</span></td>
        <td>${stepLabel}${r.session.tag==='booster'?'（B）':''}</td>
        <td>${r.session.status==='done' ? '<span class="chip good">完了</span>' : '<span class="chip">予定</span>'}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderItems(){
    const box = $('#itemsList');
    box.innerHTML='';
    if(db.items.length===0){ box.innerHTML='<div class="muted">まだ登録がありません。</div>'; return; }

    db.items.forEach(it => {
      const div = document.createElement('div');
      div.className='item';
      const stats = it.sessions.reduce((a,s)=>{ if(s.status==='done') a.done++; a.total++; return a; }, {done:0,total:0});
      div.innerHTML = `
        <div class="head">
          <div class="title">${escapeHtml(it.title)} <span class="chip">${it.kind}</span></div>
          <div class="rowBtns">
            <button class="btn ghost small" onclick="editItem('${it.id}')">編集</button>
            <button class="btn danger small" onclick="removeItem('${it.id}')">削除</button>
          </div>
        </div>
        <div class="meta">
          <span>基準日: ${fmtDate(new Date(it.base))}</span>
          <span>進捗: ${stats.done}/${stats.total}</span>
          ${it.notes?`<span class="pill">メモ: ${escapeHtml(it.notes)}</span>`:''}
        </div>
        <div class="hr"></div>
        <table class="table">
          <thead><tr><th>期日</th><th>段階</th><th>状態</th><th>結果</th><th>操作</th></tr></thead>
          <tbody>
            ${it.sessions.sort((a,b)=> new Date(a.due)-new Date(b.due)).map(s => {
              const stepLabel = s.tag==='0.5' ? '0.5' : `#${s.step}`;
              return `<tr>
                <td>${fmtDate(new Date(s.due))}</td>
                <td>${stepLabel}${s.tag==='booster'?'（B）':''}</td>
                <td>${s.status==='done'?'<span class="chip good">完了</span>':'<span class="chip">未</span>'}</td>
                <td>${s.result?`<span class="mono">${s.result}</span>`:'-'}</td>
                <td>
                  ${ s.status!=='done' ? `
                    <button class='btn small' onclick="mark('${it.id}','${toISO(new Date(s.due))}','○')">○</button>
                    <button class='btn warn small' onclick="mark('${it.id}','${toISO(new Date(s.due))}','△')">△</button>
                    <button class='btn danger small' onclick="mark('${it.id}','${toISO(new Date(s.due))}','×')">×</button>
                  `: ''}
                </td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      `;
      box.appendChild(div);
    });
  }

  // 集計ヘルパ
  function collectDueOn(day){
    const out=[];
    db.items.forEach(it => {
      it.sessions.forEach(s => { if(sameDay(new Date(s.due), day)) out.push({item:it, session:s}); });
    });
    // 基本：未完了→完了の順
    out.sort((a,b)=> (a.session.status==='done') - (b.session.status==='done'));
    return out;
  }
  function collectUpcoming(start, days){
    const until = addDays(start, days);
    const out=[];
    db.items.forEach(it => {
      it.sessions.forEach(s => {
        const d = new Date(s.due);
        if(d>start && d<=until) out.push({item:it, session:s});
      });
    });
    return out.sort((a,b)=> new Date(a.session.due)-new Date(b.session.due));
  }

  // マーク（○/△/×）
  window.mark = function(itemId, dueISO, symbol){
    const it = db.items.find(x=>x.id===itemId);
    if(!it) return;
    const s = it.sessions.find(x=>x.due===dueISO);
    if(!s) return;
    s.status='done';
    s.result=symbol;

    // 弱点対処：△ = 2日後にブースト、× = 明日ブースト
    const exam = new Date(db.exam);
    if(symbol==='△'){
      const d = addDays(new Date(dueISO), 2);
      if(d<=exam) it.sessions.push({ step:s.step, due:toISO(d), status:'pending', tag:'booster', baseStep:s.step, result:null });
    }else if(symbol==='×'){
      const d = addDays(new Date(dueISO), 1);
      if(d<=exam) it.sessions.push({ step:s.step, due:toISO(d), status:'pending', tag:'booster', baseStep:s.step, result:null });
    }

    save();
    renderAll();
  }

  // 編集/削除
  window.removeItem = function(id){
    if(!confirm('このアイテムを削除しますか？')) return;
    db.items = db.items.filter(x=>x.id!==id);
    save();
    renderAll();
  }
  window.editItem = function(id){
    const it = db.items.find(x=>x.id===id);
    if(!it){ alert('見つかりません'); return; }
    const newTitle = prompt('タイトルを編集', it.title);
    if(newTitle===null) return;
    it.title = newTitle.trim() || it.title;
    const newNotes = prompt('メモを編集（空可）', it.notes||'');
    if(newNotes!==null) it.notes = newNotes;
    save();
    renderAll();
  }

  // エクスポート/インポート/リセット
  function onExport(){
    const blob = new Blob([JSON.stringify(db,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `jlpt-n1-srs-${dateCode(new Date())}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }
  function onImport(e){
    const file = e.target.files[0]; if(!file) return;
    const r = new FileReader();
    r.onload = () => {
      try{
        const obj = JSON.parse(r.result);
        if(!obj || !obj.items) throw new Error('形式が不正です');
        db = obj; save(); renderAll(); alert('インポートしました');
      }catch(err){ alert('読み込みに失敗しました: '+err.message); }
    };
    r.readAsText(file);
  }
  function onReset(){
    if(!confirm('全データを削除しますか？（元に戻せません）')) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  // ユーティリティ
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||''); }catch(_){ return null; } }
  function toISO(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString(); }
  function toInputDate(d){ const z=new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
  function fmtDate(d){
    const f = (n)=> n<10? '0'+n : ''+n;
    if((db.prefs?.fmt||'ymd')==='md') return `${d.getMonth()+1}/${d.getDate()}`;
    return `${d.getFullYear()}-${f(d.getMonth()+1)}-${f(d.getDate())}`;
  }
  function startOfDay(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
  function addDays(date, days){ const d=new Date(date); d.setHours(d.getHours()+days*24); return d; }
  function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function firstSundayOfDecember(year){ const d=new Date(year,11,1); while(d.getDay()!==0) d.setDate(d.getDate()+1); return startOfDay(d); }
  function escapeHtml(s){ return s.replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
  function dateCode(d){ const y=d.getFullYear().toString().slice(2); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return `${y}${m}${dd}`; }
  function genId(prefix){ return `${prefix}-${Math.random().toString(36).slice(2,7)}-${Date.now().toString(36).slice(-4)}`; }
  function clearInputs(){ ['title','notes','customIntervals'].forEach(id=> $('#'+id).value=''); }
  function applyPrefs(){ $('#oneLinePref').value = db.prefs.oneLine||'on'; $('#fmtPref').value=db.prefs.fmt||'ymd'; }
})();
</script></body>
</html>          <input id="colorPicker" type="color" class="w-8 h-8 p-0 border-0 cursor-pointer" value="#fef08a"/>
        </label>
        <button id="btnExportState" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">状態をJSON保存</button>
        <label class="px-3 py-2 rounded-xl bg-white border text-sm cursor-pointer hover:bg-slate-50">
          JSON読込
          <input id="importStateInput" type="file" accept="application/json" class="hidden" />
        </label>
        <button id="btnClear" class="px-3 py-2 rounded-xl bg-white border text-sm hover:bg-slate-50">塗りを全解除</button>
        <a id="repoLink" class="text-sm underline text-slate-600 hover:text-slate-900" href="https://github.com/new" target="_blank" rel="noreferrer">GitHubに新規公開</a>
      </div>
    </div>
  </header>  <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- コントロールパネル -->
    <section class="bg-white rounded-2xl border shadow-sm p-4 sm:p-6 mb-4">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:gap-4">
        <label class="flex items-center gap-3">
          <span class="text-sm font-medium whitespace-nowrap">Excel 読み込み</span>
          <input id="fileInput" class="block w-full text-sm" type="file" accept=".xlsx,.xls,.csv" />
        </label>
        <div class="flex items-center gap-2">
          <label class="text-sm" for="sheetSelect">シート</label>
          <select id="sheetSelect" class="text-sm border rounded-xl px-3 py-2 bg-white"></select>
        </div>
        <div class="text-xs text-slate-500" id="limitNote" hidden></div>
        <div class="ml-auto text-xs text-slate-500" id="fileMeta"></div>
      </div>
    </section><!-- シート表示領域 -->
<section class="bg-white rounded-2xl border shadow-sm overflow-hidden">
  <div class="sticky top-[72px] bg-white sticky-divider px-4 py-2 text-sm text-slate-600 flex items-center justify-between">
    <div>日付セルをクリックで <span class="font-semibold">塗り/解除</span> できます（ローカルに自動保存）</div>
    <div class="hidden sm:block text-xs">※ Excel自体の塗りは変更されません。共有したい場合は「状態をJSON保存」を使ってください。</div>
  </div>
  <div id="tableWrap" class="max-h-[70vh] overflow-auto scroll-shadow">
    <div class="p-6 text-sm text-slate-500">上の「Excel 読み込み」から .xlsx/.xls/.csv を選んでください。</div>
  </div>
</section>

<!-- 使い方 -->
<section class="mt-6 text-sm text-slate-600 leading-7">
  <h2 class="text-base font-semibold mb-2">使い方</h2>
  <ol class="list-decimal ml-6 space-y-1">
    <li>「Excel 読み込み」でファイルを選びます（ブラウザ内でのみ処理。アップロードされません）。</li>
    <li>シートを選択すると内容が表で表示されます。</li>
    <li>日付が入っているセルをクリックすると塗り/解除されます。</li>
    <li>塗り状態は <span class="font-semibold">localStorage</span> に自動保存され、次回同じファイルを開くと復元されます。</li>
    <li>共有したい場合は「状態をJSON保存」で書き出し、「JSON読込」で別端末でも復元できます。</li>
  </ol>
  <p class="mt-3 text-xs text-slate-500">※ このアプリはExcelファイル自体のスタイルを書き換えません（SheetJSの無償版ではセル塗り書き出しが非対応のため）。必要なら拡張実装も可能です。</p>
</section>

  </main>  <script>
    // ====== ユーティリティ ======
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const textEncoder = new TextEncoder();

    async function sha256Hex(ab) {
      const hash = await crypto.subtle.digest('SHA-256', ab);
      return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function downloadFile(filename, data, type='application/octet-stream') {
      const blob = new Blob([data], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    function columnLabel(n) { // 0-index -> A, B, ...
      let s = ''; n++;
      while (n) { const m = (n - 1) % 26; s = String.fromCharCode(65 + m) + s; n = Math.floor((n - 1) / 26); }
      return s;
    }

    function looksLikeDateFormat(z) {
      if (!z || typeof z !== 'string') return false;
      // Excelの表示形式で日付っぽいかをざっくり判定
      return /(y|m{1,4}|d{1,4}|yy|yyyy|mmm|dddd)/i.test(z) && !/h+:?m+/i.test(z); // 時刻のみは除外
    }

    function looksLikeDateText(w) {
      if (!w || typeof w !== 'string') return false;
      // 2025/08/17, 2025-08-17, 8/17, 8-17 などざっくり
      return /^(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}|\d{1,2}[\/\-]\d{1,2})$/.test(w.trim());
    }

    function fmtCell(cell) {
      try { return XLSX.utils.format_cell(cell); } catch { return String(cell?.v ?? ''); }
    }

    // ====== アプリ状態 ======
    let g = {
      ab: null, // ArrayBuffer of file
      fileName: '',
      fileHash: '',
      wb: null, // XLSX.WorkBook
      sheetName: '',
      sheetLimit: { maxRows: 800, maxCols: 120 }, // レンダリング制限（重すぎ対策）
      paintColor: '#fef08a',
    };

    function makeStorageKey(fileHash, sheetName) {
      return `paint:${fileHash}:${sheetName}`;
    }

    function loadLocalState(fileHash, sheetName) {
      const raw = localStorage.getItem(makeStorageKey(fileHash, sheetName));
      if (!raw) return { color: g.paintColor, cells: [] };
      try { return JSON.parse(raw); } catch { return { color: g.paintColor, cells: [] }; }
    }

    function saveLocalState(fileHash, sheetName, state) {
      localStorage.setItem(makeStorageKey(fileHash, sheetName), JSON.stringify(state));
    }

    // ====== DOM refs ======
    const fileInput = document.getElementById('fileInput');
    const sheetSelect = document.getElementById('sheetSelect');
    const tableWrap = document.getElementById('tableWrap');
    const colorPicker = document.getElementById('colorPicker');
    const btnExportState = document.getElementById('btnExportState');
    const importStateInput = document.getElementById('importStateInput');
    const btnClear = document.getElementById('btnClear');
    const fileMeta = document.getElementById('fileMeta');
    const limitNote = document.getElementById('limitNote');

    // ====== ファイル読込 ======
    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      g.fileName = f.name;
      const ab = await f.arrayBuffer();
      g.ab = ab;
      g.fileHash = await sha256Hex(ab);
      fileMeta.textContent = `${g.fileName} / SHA-256: ${g.fileHash.slice(0, 10)}…`;

      // CSVは内部でシート化される
      const wb = XLSX.read(ab, { type: 'array', cellDates: true, dateNF: 'yyyy-mm-dd' });
      g.wb = wb;
      sheetSelect.innerHTML = '';
      wb.SheetNames.forEach((name, i) => {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name; if (i === 0) opt.selected = true;
        sheetSelect.appendChild(opt);
      });
      g.sheetName = wb.SheetNames[0] || '';
      renderSheet(g.sheetName);
    });

    sheetSelect.addEventListener('change', (e) => {
      g.sheetName = e.target.value;
      renderSheet(g.sheetName);
    });

    colorPicker.addEventListener('input', () => {
      g.paintColor = colorPicker.value || '#fef08a';
      const table = tableWrap.querySelector('table.sheet');
      if (table) table.style.setProperty('--paint', g.paintColor);
      // ついでに保存中の色も更新
      const st = loadLocalState(g.fileHash, g.sheetName);
      st.color = g.paintColor; saveLocalState(g.fileHash, g.sheetName, st);
    });

    btnExportState.addEventListener('click', () => {
      if (!g.fileHash || !g.sheetName) return;
      const st = loadLocalState(g.fileHash, g.sheetName);
      const payload = { version: 1, fileHash: g.fileHash, sheetName: g.sheetName, ...st };
      downloadFile(`paint-state_${g.sheetName}.json`, JSON.stringify(payload, null, 2), 'application/json');
    });

    importStateInput.addEventListener('change', async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const text = await f.text();
      try {
        const obj = JSON.parse(text);
        if (!obj || typeof obj !== 'object' || !obj.sheetName || !obj.fileHash) throw new Error('形式が不正です');
        // 現在のファイルとハッシュが違うと適用せず警告
        if (obj.fileHash !== g.fileHash) {
          alert('この状態JSONは異なるExcelファイルのものです。元のExcelを開いた上で再度読み込んでください。');
          importStateInput.value = '';
          return;
        }
        saveLocalState(g.fileHash, obj.sheetName, { color: obj.color || '#fef08a', cells: obj.cells || [] });
        if (obj.sheetName === g.sheetName) applyPaintFromState();
        alert('状態を適用しました。');
      } catch (err) {
        alert('JSONの読み込みに失敗しました: ' + err.message);
      } finally {
        importStateInput.value = '';
      }
    });

    btnClear.addEventListener('click', () => {
      if (!g.fileHash || !g.sheetName) return;
      const table = tableWrap.querySelector('table.sheet');
      if (!table) return;
      table.querySelectorAll('td.painted').forEach(td => td.classList.remove('painted'));
      saveLocalState(g.fileHash, g.sheetName, { color: g.paintColor, cells: [] });
    });

    // ====== レンダリング ======
    function renderSheet(name) {
      const ws = g.wb?.Sheets?.[name];
      if (!ws) { tableWrap.innerHTML = '<div class="p-6 text-sm text-slate-500">このシートは空です。</div>'; return; }

      const ref = ws['!ref'] || 'A1';
      const range = XLSX.utils.decode_range(ref);
      const totalRows = (range.e.r - range.s.r + 1);
      const totalCols = (range.e.c - range.s.c + 1);

      const maxRows = Math.min(totalRows, g.sheetLimit.maxRows);
      const maxCols = Math.min(totalCols, g.sheetLimit.maxCols);

      limitNote.hidden = (totalRows <= maxRows && totalCols <= maxCols);
      if (!limitNote.hidden) {
        limitNote.textContent = `表示を制限しています（${maxRows}/${totalRows} 行, ${maxCols}/${totalCols} 列）。必要なら上限値をコード内で調整してください。`;
      }

      const table = document.createElement('table');
      table.className = 'sheet';
      table.style.setProperty('--paint', g.paintColor);

      const thead = document.createElement('thead');
      const thr = document.createElement('tr');
      const corner = document.createElement('th');
      corner.className = 'row-head'; corner.textContent = '#';
      thr.appendChild(corner);
      for (let c = 0; c < maxCols; c++) {
        const th = document.createElement('th');
        th.textContent = columnLabel(c);
        thr.appendChild(th);
      }
      thead.appendChild(thr);

      const tbody = document.createElement('tbody');
      for (let r = 0; r < maxRows; r++) {
        const tr = document.createElement('tr');
        const rowHead = document.createElement('th');
        rowHead.className = 'row-head'; rowHead.textContent = (r + 1).toString();
        tr.appendChild(rowHead);
        for (let c = 0; c < maxCols; c++) {
          const rr = range.s.r + r;
          const cc = range.s.c + c;
          const addr = XLSX.utils.encode_cell({ r: rr, c: cc });
          const cell = ws[addr];
          const td = document.createElement('td');
          td.dataset.addr = addr;

          let isDate = false;
          if (cell) {
            const t = cell.t;
            if (t === 'd') isDate = true; // 既に日付型
            else if (t === 'n' && looksLikeDateFormat(cell.z)) isDate = true; // 数値 + 日付書式
            else if ((t === 's' || t === 'n') && looksLikeDateText(cell.w || cell.v)) isDate = true; // 文字列上で日付らしい
            td.textContent = fmtCell(cell);
          } else {
            td.textContent = '';
          }

          if (isDate) {
            td.classList.add('date-cell');
            td.title = `クリックで塗り/解除 (${addr})`;
            td.addEventListener('click', () => togglePaint(td));
          }

          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      table.appendChild(thead);
      table.appendChild(tbody);

      tableWrap.innerHTML = '';
      tableWrap.appendChild(table);

      applyPaintFromState();
    }

    function togglePaint(td) {
      td.classList.toggle('painted');
      persistPaint();
    }

    function persistPaint() {
      if (!g.fileHash || !g.sheetName) return;
      const table = tableWrap.querySelector('table.sheet');
      if (!table) return;
      const addrs = $$('.painted', table).map(td => td.dataset.addr).filter(Boolean);
      saveLocalState(g.fileHash, g.sheetName, { color: g.paintColor, cells: addrs });
    }

    function applyPaintFromState() {
      const table = tableWrap.querySelector('table.sheet');
      if (!table) return;
      const st = loadLocalState(g.fileHash, g.sheetName);
      g.paintColor = st.color || g.paintColor; // カラーピッカーも同期
      colorPicker.value = g.paintColor;
      table.style.setProperty('--paint', g.paintColor);
      // いったん全解除
      table.querySelectorAll('td.painted').forEach(td => td.classList.remove('painted'));
      // 適用
      (st.cells || []).forEach(addr => {
        const td = table.querySelector(`td[data-addr="${addr}"]`);
        if (td) td.classList.add('painted');
      });
    }

    // 初期化（色だけ反映）
    document.addEventListener('DOMContentLoaded', () => {
      const table = tableWrap.querySelector('table.sheet');
      if (table) table.style.setProperty('--paint', g.paintColor);
    });
  </script></body>
</html>        <button id="rebuildBtn" class="btn btn-primary">再生成</button>
        <button id="todayBtn" class="btn btn-secondary">今日へジャンプ</button>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="exportBtn" class="btn btn-secondary">進捗をエクスポート</button>
        <label class="btn btn-secondary cursor-pointer">
          進捗をインポート
          <input id="importInput" type="file" accept="application/json" class="hidden" />
        </label>
        <button id="resetBtn" class="btn btn-secondary">全部リセット</button>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-3">
      <h2 class="font-semibold mb-2">今日のToDo</h2>
      <div id="todayList" class="text-sm text-gray-800"></div>
    </div>

    <div class="bg-white rounded-lg shadow p-3 overflow-auto">
      <table id="grid" class="min-w-full text-sm">
        <thead class="sticky top-0 bg-white z-10">
          <tr>
            <th class="sticky-th p-2 text-left">学習項目</th>
            <th class="p-2 nowrap">初回</th>
            <th class="p-2 nowrap">0</th>
            <th class="p-2 nowrap">0.5 (夜)</th>
            <th class="p-2 nowrap">1</th>
            <th class="p-2 nowrap">2</th>
            <th class="p-2 nowrap">3</th>
            <th class="p-2 nowrap">4</th>
            <th class="p-2 nowrap">5</th>
            <th class="p-2 nowrap">6</th>
            <th class="p-2 nowrap">7</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <details class="bg-white rounded-lg shadow p-3">
      <summary class="cursor-pointer font-semibold">ヘルプ</summary>
      <ul class="list-disc ml-5 text-sm text-gray-700 space-y-1 mt-2">
        <li>セルをタップ（クリック）で状態を切り替え：未完 → 完了（緑）。</li>
        <li>「今日のToDo」からもチェックすると、表側のセルが連動して塗られます。</li>
        <li>進捗は端末の <code>localStorage</code> に保存。エクスポート/インポートで他端末に移行可能。</li>
        <li>開始日や1日の新規数を変えたら「再生成」。</li>
      </ul>
    </details>
  </div>

  <script>
  // ---------------- Topics (目次) ----------------
  const TOPICS = [
    "01 データの単位","02 数値の数え方","03 基数変換と桁の話","04 さまざまな記数法変換",
    "05 負の2進数","06 2進数の四則演算",
    "07 集合と論理演算","08 論理回路","09 計算式の表し方","10 オートマトン","11 AI（人工知能）",
    "12 データ構造","13 アルゴリズムの基本","14 アルゴリズムの分類","15 プログラムの性質と種類","16 その他の言語",
    "17 CPU（プロセッサ）","18 CPUが処理する流れ","19 記憶装置","20 入出力装置",
    "21 システムの分類","22 システム構成による分類","23 システムの性能指標","24 システムの信頼性指標",
    "25 OS","26 データ管理とファイルシステム","27 バックアップ","28 開発ツール","29 オープンソースソフトウェア",
    "30 半導体メモリ","31 電子回路",
    "32 ヒューマンインターフェース技術","33 インタフェース設計","34 マルチメディア技術",
    "35 データベースの基本","36 関係データベース","37 データベース設計","38 データベース管理システム",
    "39 トランザクション管理","40 排他制御",
    "41 回線","42 LANとWAN","43 IPアドレス","44 サブネットマスク","45 グローバル/プライベートIP",
    "46 ドメイン名","47 通信プロトコル","48 インターネット応用",
    "49 セキュリティの脅威","50 暗号技術の基本","51 デジタル署名と認証局","52 リスクマネジメント",
    "53 セキュリティマネジメント","54 脅威への対策",
    "55 システム開発技術","56 システム要件定義","57 システム設計","58 プログラミングとオブジェクト指向","59 テスト",
    "60 ソフトウェア開発モデル",
    "61 プロジェクトマネジメント","62 スコープマネジメント","63 リソースマネジメント","64 タイムマネジメント",
    "65 コストマネジメント","66 リスクマネジメント",
    "67 サービスマネジメント","68 サービスレベル管理","69 サービスデスク","70 ファシリティマネジメント",
    "71 システム監査","72 内部統制",
    "73 情報システム戦略","74 業務プロセス","75 ソリューションビジネス","76 活用促進と評価",
    "77 システム企画","78 調達計画・実施",
    "79 経営戦略","80 会社戦略","81 事業戦略","82 評価","83 マーケティング","84 組織マネジメント","85 財務",
    "86 法務","87 知的財産","88 セキュリティ関連法","89 労働関連法",
    "90 試験対策（科目Bの合格戦略）"
  ];
  const INTERVALS = [0, 0.5, 1, 2, 3, 4, 5, 6, 7];
  const COL_KEYS = ["init","0","0.5","1","2","3","4","5","6","7"]; // init + intervals
  const STORAGE_KEY = "fe_memory_plan_v1";

  // --------- helpers ---------
  const fmtYMD = (d) => d.toISOString().slice(0,10);
  const fmtMD = (d) => `${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
  function addDays(base, days){
    const ms = base.getTime() + days*24*60*60*1000;
    return new Date(ms);
  }
  function allocate(topics, startDate, perDay){
    const plan = []; // [{topic, dates:{init, "0","0.5","1"...}}]
    let dayIndex = 0;
    for (let i=0; i<topics.length; ){
      const count = Math.min(perDay, topics.length - i);
      const initial = addDays(startDate, dayIndex);
      for (let k=0; k<count; k++){
        const t = topics[i+k];
        const dates = {"init": fmtYMD(initial)};
        for (const iv of INTERVALS){
          const d = addDays(initial, iv);
          const key = String(iv);
          dates[key] = fmtYMD(d);
        }
        plan.push({topic: t, dates});
      }
      i += count;
      dayIndex += 1;
    }
    return plan;
  }

  // --------- state ---------
  let startDate = new Date();
  let perDay = 3;
  let plan = [];           // allocate result
  let progress = {};       // { startDateYMD: { "<topicIndex>|<colKey>": true } }

  // Load progress
  function loadProgress(){
    try{
      progress = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    }catch{ progress = {}; }
  }
  function saveProgress(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
  }
  function getKeyForDate(d){ return fmtYMD(d); }

  // mark helpers
  function isDone(topicIndex, colKey){
    const planKey = getKeyForDate(startDate);
    const store = progress[planKey] || {};
    return !!store[`${topicIndex}|${colKey}`];
  }
  function toggleDone(topicIndex, colKey){
    const planKey = getKeyForDate(startDate);
    if(!progress[planKey]) progress[planKey] = {};
    const k = `${topicIndex}|${colKey}`;
    progress[planKey][k] = !progress[planKey][k];
    saveProgress();
  }

  // --------- UI build ---------
  const tbody = document.getElementById("tbody");
  function rebuildGrid(){
    tbody.innerHTML = "";
    // header inputs reflect
    document.getElementById("startDate").value = fmtYMD(startDate);
    document.getElementById("perDay").value = perDay;
    const todayYMD = fmtYMD(new Date());

    plan = allocate(TOPICS, startDate, perDay);

    plan.forEach((row, idx) => {
      const tr = document.createElement("tr");
      // topic cell
      const tdTopic = document.createElement("td");
      tdTopic.className = "sticky-first p-2 border-b border-gray-200 bg-white";
      tdTopic.textContent = row.topic;
      tr.appendChild(tdTopic);

      // columns: init + intervals
      // init
      const initDate = row.dates["init"];
      tr.appendChild(makeCell(idx, "init", initDate, todayYMD));

      for (const iv of INTERVALS){
        const key = String(iv);
        const d = row.dates[key];
        const label = key === "0.5" ? d + " 夜" : d;
        tr.appendChild(makeCell(idx, key, label, todayYMD, d));
      }
      tbody.appendChild(tr);
    });

    renderTodayList();
  }

  function makeCell(idx, colKey, label, todayYMD, rawYMD=null){
    const td = document.createElement("td");
    td.className = "cell text-center p-2 border-b border-gray-100";
    td.dataset.idx = idx;
    td.dataset.col = colKey;
    td.title = label;

    // visual date (MM/DD) only
    const ymd = (rawYMD || label).slice(0,10);
    const d = new Date(ymd);
    const visual = (colKey==="0.5") ? fmtMD(d) + " 夜" : fmtMD(d);
    td.innerHTML = `<span class="small">${visual}</span>`;

    // state
    if (isDone(idx, colKey)) td.classList.add("done");
    if (ymd < todayYMD) td.classList.add("overdue");
    if (ymd === todayYMD) td.classList.add("today");

    // toggle
    td.addEventListener("click", () => {
      toggleDone(idx, colKey);
      td.classList.toggle("done");
    });
    return td;
  }

  // --------- Today list ---------
  function renderTodayList(){
    const box = document.getElementById("todayList");
    const today = new Date();
    const todayYMD = fmtYMD(today);
    const items = [];
    plan.forEach((row, idx) => {
      for (const key of COL_KEYS){
        const ymd = row.dates[key];
        if (!ymd) continue;
        if (ymd === todayYMD){
          const title = (key==="0.5") ? `${row.topic}（夜）` : row.topic;
          items.push({idx, key, title});
        }
      }
    });
    if (!items.length){
      box.innerHTML = `<p class="text-gray-500">本日分はありません。</p>`;
      return;
    }
    // list
    box.innerHTML = "";
    const ul = document.createElement("ul");
    ul.className = "list-disc ml-5";
    items.forEach(item => {
      const li = document.createElement("li");
      const btn = document.createElement("button");
      btn.className = "underline text-blue-600";
      btn.textContent = item.title;
      btn.addEventListener("click", () => {
        // toggle and sync cell
        toggleDone(item.idx, item.key);
        // find cell and toggle class
        const selector = `td.cell[data-idx="${item.idx}"][data-col="${item.key}"]`;
        const cell = document.querySelector(selector);
        if (cell) cell.classList.toggle("done");
      });
      li.appendChild(btn);
      ul.appendChild(li);
    });
    box.appendChild(ul);
  }

  // --------- Controls ---------
  document.getElementById("rebuildBtn").addEventListener("click", () => {
    const d = document.getElementById("startDate").value;
    startDate = d ? new Date(d+"T00:00:00") : new Date();
    perDay = Math.max(1, Math.min(10, parseInt(document.getElementById("perDay").value||"3",10)));
    rebuildGrid();
  });
  document.getElementById("todayBtn").addEventListener("click", () => {
    const todayYMD = fmtYMD(new Date());
    const cell = document.querySelector(`td.cell.today`);
    if (cell) cell.scrollIntoView({behavior:"smooth", block:"center"});
  });
  document.getElementById("resetBtn").addEventListener("click", () => {
    if (!confirm("すべての塗りつぶしを消去します。よろしいですか？")) return;
    const key = getKeyForDate(startDate);
    if (progress[key]) delete progress[key];
    saveProgress();
    rebuildGrid();
  });
  document.getElementById("exportBtn").addEventListener("click", () => {
    const dataStr = JSON.stringify(progress, null, 2);
    const blob = new Blob([dataStr], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "fe_memory_progress.json";
    a.click();
  });
  document.getElementById("importInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        progress = JSON.parse(reader.result);
        saveProgress();
        rebuildGrid();
        alert("インポートしました。");
      }catch(err){
        alert("JSONの読み込みに失敗しました。");
      }
    };
    reader.readAsText(file);
  });

  // --------- init ---------
  (function init(){
    loadProgress();
    const d = new Date();
    document.getElementById("startDate").value = fmtYMD(d);
    startDate = d;
    perDay = 3;
    rebuildGrid();
  })();
  </script>
</body>
</html>
