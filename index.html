<!doctype html>

<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JLPT N1 読解SRS（日付塗りつぶし）</title>
</head>
<body>
  <div id="app" style="max-width:1100px;margin:0 auto;padding:14px"></div><script>
(function(){
  // ====== CSS（JS注入で <style> 表示問題を回避） ======
  const CSS = `
  :root{--bg:#0c0f13;--card:#12161c;--ink:#e9eef4;--muted:#a6b0bb;--line:#222830;--accent:#57b1ff;--done:#2dd4bf;--warn:#ffd166}
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:"Meiryo UI",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;background:linear-gradient(180deg,#0c0f13 0%,#0e1217 100%);color:var(--ink)}
  header{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{font-size:20px;margin:6px 0}.sub{color:var(--muted);font-size:13px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.22);margin-top:10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input{width:100%;padding:10px 12px;background:#0e1217;color:var(--ink);border:1px solid var(--line);border-radius:10px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:none;background:var(--accent);color:#04121d;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
  .btn.warn{background:var(--warn);color:#241b00}
  .btn.small{padding:6px 10px;border-radius:10px;font-size:12px}
  .chip{font-size:11px;padding:4px 8px;border-radius:999px;background:#0e1217;border:1px solid var(--line);color:var(--muted)}
  .grid{display:grid;gap:10px}.grid.cols-3{grid-template-columns:1fr}@media(min-width:900px){.grid.cols-3{grid-template-columns:1.2fr 1fr 1fr}}
  .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
  table{border-collapse:separate;border-spacing:0;width:100%;font-size:13px}
  th,td{border-bottom:1px solid var(--line);border-right:1px solid var(--line);padding:8px 6px;text-align:left;white-space:nowrap}
  th:last-child,td:last-child{border-right:none}
  thead th{position:sticky;top:0;background:#0f141b;z-index:2}
  .cell{min-width:76px;text-align:center;border-radius:8px;cursor:pointer;user-select:none}
  .cell.done{background:var(--done);color:#04121d;font-weight:700}
  .cell.past:not(.done){opacity:.45}
  .cell.today{outline:2px solid #457bff;outline-offset:-2px}
  .hint{color:var(--muted);font-size:12px}
  `;
  const style = document.createElement('style'); style.textContent = CSS; document.head.appendChild(style);

  // ====== 画面 ======
  const app = document.getElementById('app');
  app.innerHTML = `
    <header>
      <div>
        <h1>JLPT N1 読解SRS（塗りつぶし表）</h1>
        <div class="sub">日付セルをタップして塗るだけ。タイトルは「新完全マスターN1読解」の目次ベース。</div>
      </div>
      <div class="row">
        <span class="chip" id="todayChip">今日: -</span>
        <span class="chip" id="examChip">試験日: -</span>
      </div>
    </header>

    <section class="card">
      <div class="grid cols-3">
        <div>
          <label>開始日</label>
          <input type="date" id="startDate"/>
        </div>
        <div>
          <label>試験日</label>
          <input type="date" id="examDate"/>
        </div>
        <div>
          <label>復習間隔（固定）</label>
          <div class="chip">0.5 / 1 / 2 / 4 / 7 / 14 / 21 / 28（日）</div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="genBtn">スケジュール自動生成（上書き）</button>
        <button class="btn ghost" id="todayOnlyBtn">今日だけ表示/解除</button>
        <button class="btn warn" id="clearMarksBtn">塗りつぶしを全て消す</button>
      </div>
      <div class="hint">※ 行（項目）を上書きします（塗りつぶしは保持）。</div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">今日のタスク</h3>
      <div id="todayList" class="row" style="gap:6px;flex-wrap:wrap"></div>
    </section>

    <section class="card">
      <div class="tableWrap">
        <table id="grid"><thead></thead><tbody></tbody></table>
      </div>
      <div class="hint" style="margin-top:6px">セルをタップ/クリックで塗りつぶし（もう一度で解除）。</div>
    </section>
  `;

  // ====== データ ======
  // 目次ベースのタイトルプール（短い見出しのみ・一般語彙）
  const TITLE_POOL = [
    // PART1 第1章 短文・中文
    'UNIT1 指示詞の内容','UNIT2 事実関係','UNIT3 語彙の意味','UNIT4 話の展開','UNIT5 人物の気持ち','UNIT6 理由や根拠','UNIT7 全体の内容','UNIT8 筆者が言いたいこと','UNIT9 連絡文','UNIT10 情報検索',
    // PART1 第2章 長文 A
    '長文A UNIT1 解説','長文A UNIT2 論説',
    // PART1 第2章 長文 B
    '長文B UNIT1 エッセイ','長文B UNIT2 小説',
    // PART1 第3章
    'UNIT3 紀行文',
    // PART2 第1章 対策準備
    '対策準備 UNIT1 基本的な読み方','対策準備 UNIT2 チェックの仕方','対策準備 UNIT3 指示詞（コア表現）の整理','対策準備 UNIT4 文末表現の整理','対策準備 UNIT5 接続詞の整理',
    // PART2 第2章 実戦練習
    '実戦練習 UNIT1 内容理解（短文）','実戦練習 UNIT2 内容理解（中文）','実戦練習 UNIT3 内容理解（長文）','実戦練習 UNIT4 統合理解','実戦練習 UNIT5 主張理解（長文）','実戦練習 UNIT6 情報検索'
  ];

  const SIM_TITLE_BASE = '模擬試験（通し）';

  const STORAGE_KEY = 'jlptn1_simple_srs_v4';
  const $ = s=>document.querySelector(s);

  // ====== 日付ユーティリティ ======
  function startOfDay(d){const x=new Date(d);x.setHours(0,0,0,0);return x}
  function addDays(d,days){const x=new Date(d);x.setDate(x.getDate()+Math.floor(days));return x}
  function addFracDaysAsDate(d,days){return days<1? startOfDay(d):addDays(d,days)}
  function fmt(d){const m=d.getMonth()+1;const dd=d.getDate();return `${m}/${dd}`}
  function toInput(d){const z=new Date(d.getTime()-d.getTimezoneOffset()*60000);return z.toISOString().slice(0,10)}
  function fromInput(s){return startOfDay(new Date(s))}
  function firstSundayOfDecember(y){const d=new Date(y,11,1);while(d.getDay()!==0)d.setDate(d.getDate()+1);return startOfDay(d)}
  function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}

  const today = startOfDay(new Date());
  $('#todayChip').textContent = `今日: ${fmt(today)}`;

  const defExam = firstSundayOfDecember(new Date().getFullYear());
  const INTERVALS = [0.5,1,2,4,7,14,21,28];

  let db = load() || { start: toInput(today), exam: toInput(defExam), rows: [], marks:{} };
  $('#startDate').value = db.start; $('#examDate').value = db.exam; $('#examChip').textContent = `試験日: ${fmt(fromInput(db.exam))}`;

  // イベント
  document.getElementById('genBtn').addEventListener('click', regenerate);
  document.getElementById('todayOnlyBtn').addEventListener('click', ()=>{ state.todayOnly=!state.todayOnly; render(); });
  document.getElementById('clearMarksBtn').addEventListener('click', ()=>{ if(confirm('全ての塗りつぶしを消しますか？')){ db.marks={}; save(); render(); }});
  document.getElementById('startDate').addEventListener('change', ()=>{ db.start=document.getElementById('startDate').value; save(); });
  document.getElementById('examDate').addEventListener('change', ()=>{ db.exam=document.getElementById('examDate').value; save(); document.getElementById('examChip').textContent=`試験日: ${fmt(fromInput(db.exam))}`; });

  const state = { todayOnly:false };

  if(!db.rows.length) regenerate(); else render();

  // ====== 生成ロジック ======
  function regenerate(){
    const start = fromInput(document.getElementById('startDate').value||db.start);
    const exam = fromInput(document.getElementById('examDate').value||db.exam);
    if(!(start<exam)){ alert('開始日が試験日より前である必要があります'); return; }

    const prevMarks = db.marks || {};
    const rows = [];

    let poolIdx = 0; let round = 1; let simCount = 0;

    for(let d=new Date(start); d<exam; d.setDate(d.getDate()+1)){
      let title;
      if(d.getDay()===0){ // 日曜は模試
        simCount++; title = `${SIM_TITLE_BASE} 第${simCount}回`;
      } else {
        title = TITLE_POOL[poolIdx];
        if(round>1) title += `（第${round}周）`;
        poolIdx++;
        if(poolIdx>=TITLE_POOL.length){ poolIdx=0; round++; }
      }

      const dates = INTERVALS.map(k=> addFracDaysAsDate(d,k));
      const due = dates.filter(dd=> dd<=exam);
      rows.push({ id: genId('RD'), base: toInput(d), title, due: due.map(x=>toInput(x)) });
    }

    db.rows = rows; db.start = toInput(start); db.exam = toInput(exam); db.marks = prevMarks;
    save(); render();
  }

  // ====== 描画 ======
  function render(){
    const thead = document.querySelector('#grid thead');
    const tbody = document.querySelector('#grid tbody');
    thead.innerHTML=''; tbody.innerHTML='';

    const tr = document.createElement('tr');
    tr.innerHTML = `<th>タイトル</th><th>基準日</th>${INTERVALS.map(i=>`<th>${i===0.5?'0.5':i}</th>`).join('')}`;
    thead.appendChild(tr);

    const exam = fromInput(db.exam);
    const tBox = document.getElementById('todayList'); tBox.innerHTML='';
    const rows = (db.rows||[]).filter(r=> r.due.length>0);

    for(const row of rows){
      const hasToday = row.due.some(dd=> sameDay(fromInput(dd), today));
      if(state.todayOnly && !hasToday) continue;

      const trb = document.createElement('tr');
      trb.appendChild(th(`${escapeHtml(row.title)}`));
      trb.appendChild(td(fmt(fromInput(row.base))));

      INTERVALS.forEach((ival, idx)=>{
        const d = addFracDaysAsDate(fromInput(row.base), ival);
        let cell = td('-');
        if(d<=exam){
          const key = `${row.id}|${toInput(d)}|${idx}`;
          const marked = !!db.marks[key];
          const isToday = sameDay(d, today);
          const past = d<today;
          cell = td(fmt(d));
          cell.className = 'cell' + (marked?' done':'') + (past&&!marked?' past':'') + (isToday?' today':'');
          cell.dataset.key = key;
          if(isToday){
            const b = document.createElement('button');
            b.className='btn small' + (marked?' ghost':'');
            b.textContent = `${row.title}  #${ival===0.5?'0.5':ival}`;
            b.addEventListener('click', ()=> toggleMark(key));
            tBox.appendChild(b);
          }
        }
        trb.appendChild(cell);
      });
      tbody.appendChild(trb);
    }

    tbody.querySelectorAll('.cell').forEach(el=>{
      el.addEventListener('click', e=>{ const key = e.currentTarget.dataset.key; if(!key) return; toggleMark(key); });
    });
  }

  // ====== 汎用 ======
  function th(html){ const e=document.createElement('th'); e.innerHTML=html; return e }
  function td(text){ const e=document.createElement('td'); e.textContent=text; return e }
  function toggleMark(key){ db.marks[key] = !db.marks[key]; save(); render(); }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||''); }catch(_){ return null; } }
  function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
  function genId(p){return `${p}-${Math.random().toString(36).slice(2,7)}-${Date.now().toString(36).slice(-4)}`}
})();
</script></body>
</html>
