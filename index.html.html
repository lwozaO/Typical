<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ™ãƒˆãƒŠãƒ èª 4æŠã‚¯ã‚¤ã‚ºï¼ˆJPâ†”VIï¼‰</title>
  <style>
    :root {
      --bg: #fafafa;
      --fg: #111;
      --muted: #6b7280;
      --border: #e5e7eb;
      --primary: #111827;
      --accent: #2563eb;
      --green: #16a34a;
      --red: #dc2626;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { max-width: 920px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 1.75rem; margin: 0 0 4px; }
    .sub { color: var(--muted); font-size: 0.9rem; }

    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .select, .btn { border: 1px solid var(--border); background: #fff; padding: 8px 12px; border-radius: 10px; font-size: 0.95rem; }
    .btn { cursor: pointer; }
    .btn:hover { box-shadow: 0 1px 0 rgba(0,0,0,.05); }
    .btn.primary { background: #f9fafb; }
    .btn.on { background: #ecfdf5; border-color: #86efac; }

    .grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .card { background: #fff; border: 1px solid var(--border); border-radius: 16px; padding: 12px; }
    .card.shadow { box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .muted { color: var(--muted); font-size: .85rem; }
    .big { font-size: 1.5rem; font-weight: 700; }

    details { border: 1px solid var(--border); border-radius: 16px; padding: 12px; background: #fff; }
    summary { cursor: pointer; color: var(--primary); }

    .qhead { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
    .qprompt { margin-top: 6px; font-size: 1.6rem; font-weight: 800; word-break: break-word; }
    .optgrid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 640px) { .optgrid { grid-template-columns: 1fr 1fr; } }
    .opt { text-align: left; display: block; width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 16px; background: #fff; cursor: pointer; }
    .opt:hover { box-shadow: 0 2px 6px rgba(0,0,0,.05); }
    .opt .num { display: inline-flex; width: 28px; height: 28px; align-items: center; justify-content: center; border: 1px solid var(--border); border-radius: 999px; font-weight: 600; margin-right: 10px; }
    .opt.correct { background: #f0fdf4; border-color: #86efac; }
    .opt.wrong { background: #fef2f2; border-color: #fecaca; }

    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .spacer { height: 8px; }
    .chip { display: inline-flex; gap: 8px; align-items: center; padding: 6px 12px; border: 1px solid var(--border); border-radius: 999px; }
    .footer { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 8px; }
    code { background: #f3f4f6; padding: 2px 6px; border-radius: 6px; }
    textarea { width: 100%; min-height: 120px; border: 1px solid var(--border); border-radius: 12px; padding: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: .9rem; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <header class="row" style="align-items: end; justify-content: space-between;">
      <div>
        <h1>ãƒ™ãƒˆãƒŠãƒ èª 4æŠã‚¯ã‚¤ã‚º</h1>
        <div class="sub">æ—¥æœ¬èªâ†”ãƒ™ãƒˆãƒŠãƒ èªï¼éŸ³å£°ã¤ããƒ»ã‚«ãƒ†ã‚´ãƒªçµã‚Šè¾¼ã¿ãƒ»é€²æ—ä¿å­˜ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯ï¼‰</div>
      </div>
      <div class="toolbar">
        <select id="direction" class="select">
          <option>JPâ†’VI</option>
          <option>VIâ†’JP</option>
        </select>
        <button id="audioBtn" class="btn">ğŸ”Š éŸ³å£°OFF</button>
        <button id="exportBtn" class="btn">ãƒ‡ãƒƒã‚­æ›¸ãå‡ºã—</button>
        <button id="importBtn" class="btn">ãƒ‡ãƒƒã‚­èª­ã¿è¾¼ã¿</button>
        <input id="fileInput" type="file" accept=".json,.csv,.tsv,.txt" class="hidden" />
      </div>
    </header>

    <section class="spacer"></section>

    <section class="grid3">
      <div class="card">
        <div class="muted">å‡ºé¡Œæ•°</div>
        <div class="big" id="statAsked">0</div>
      </div>
      <div class="card">
        <div class="muted">æ­£ç­”ç‡</div>
        <div class="big" id="statAcc">0%</div>
      </div>
      <div class="card">
        <div class="muted">é€£ç¶šæ­£è§£</div>
        <div class="big" id="statStreak">0</div>
      </div>
    </section>

    <section class="spacer"></section>

    <section>
      <details>
        <summary>ã‚«ãƒ†ã‚´ãƒªçµã‚Šè¾¼ã¿</summary>
        <div id="catArea" class="row" style="margin-top:10px;"></div>
      </details>
    </section>

    <section class="spacer"></section>

    <section id="qCard" class="card shadow"></section>

    <section class="spacer"></section>

    <section>
      <details>
        <summary>å¾©ç¿’ãƒ»ãƒŸã‚¹ãŒå¤šã„èª</summary>
        <div id="reviewArea" class="row" style="margin-top:10px; flex-direction: column; gap: 8px;"></div>
      </details>
    </section>

    <section class="spacer"></section>

    <section>
      <details>
        <summary>è‡ªåˆ†ã®èªå½™ã‚’è¿½åŠ ï¼ˆ1è¡Œ1èªï¼švi,jp,cat,hintï¼‰</summary>
        <div style="margin-top:10px;">
          <textarea id="appendText" placeholder="xin chÃ o,ã“ã‚“ã«ã¡ã¯,greeting\nbao nhiÃªu?,ã„ãã‚‰ï¼Ÿ,money\nnhÃ  vá»‡ sinh,ãƒˆã‚¤ãƒ¬,place"></textarea>
          <div class="row" style="margin-top:8px;">
            <button id="appendBtn" class="btn">è¿½åŠ </button>
            <div class="muted">CSV/TSVå¯ã€‚ä¾‹ï¼š<code>tÃ´i tÃªn lÃ  ~,ç§ã®åå‰ã¯ã€œã§ã™,greeting</code></div>
          </div>
        </div>
      </details>
    </section>

    <section class="spacer"></section>

    <footer class="footer">
      <div class="muted">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼š1ã€œ4ã§å›ç­”ï¼N æ¬¡ã¸ï¼S ç™ºéŸ³ï¼I ã‚ã‹ã‚‰ãªã„</div>
      <div class="row">
        <button id="resetBtn" class="btn">é€²æ—ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="refreshBtn" class="btn">å•é¡Œã‚’æ›´æ–°</button>
      </div>
    </footer>
  </div>

  <script>
  // =============================
  // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆä¼šè©±é »å‡ºèªï¼‰
  // =============================
  const BASE_DECK = [
    { vi: "xin chÃ o", jp: "ã“ã‚“ã«ã¡ã¯", cat: "greeting", hint: "ä¸å¯§ãªã‚ã„ã•ã¤" },
    { vi: "chÃ o buá»•i sÃ¡ng", jp: "ãŠã¯ã‚ˆã†", cat: "greeting" },
    { vi: "chÃ o buá»•i tá»‘i", jp: "ã“ã‚“ã°ã‚“ã¯", cat: "greeting" },
    { vi: "táº¡m biá»‡t", jp: "ã•ã‚ˆã†ãªã‚‰", cat: "greeting" },
    { vi: "háº¹n gáº·p láº¡i", jp: "ã¾ãŸä¼šã„ã¾ã—ã‚‡ã†", cat: "greeting" },
    { vi: "cáº£m Æ¡n", jp: "ã‚ã‚ŠãŒã¨ã†", cat: "greeting" },
    { vi: "xin lá»—i", jp: "ã”ã‚ã‚“ãªã•ã„", cat: "greeting" },
    { vi: "khÃ´ng sao", jp: "å¤§ä¸ˆå¤«ã§ã™", cat: "greeting" },
    { vi: "vui lÃ²ng", jp: "ãŠé¡˜ã„ã—ã¾ã™", cat: "greeting" },
    { vi: "lÃ m Æ¡n", jp: "ãŠé¡˜ã„ã—ã¾ã™ï¼ˆä¾é ¼ï¼‰", cat: "greeting" },
    { vi: "ráº¥t vui Ä‘Æ°á»£c gáº·p báº¡n", jp: "ãŠä¼šã„ã§ãã¦å¬‰ã—ã„ã§ã™", cat: "greeting" },
    { vi: "tÃªn", jp: "åå‰", cat: "greeting" },
    { vi: "tÃ´i tÃªn lÃ  ~", jp: "ç§ã®åå‰ã¯ã€œã§ã™", cat: "greeting" },
    { vi: "báº¡n tÃªn gÃ¬?", jp: "ãŠåå‰ã¯ï¼Ÿ", cat: "greeting" },
    { vi: "Ä‘i", jp: "è¡Œã", cat: "verb" },
    { vi: "Ä‘áº¿n", jp: "æ¥ã‚‹", cat: "verb" },
    { vi: "vá»", jp: "å¸°ã‚‹", cat: "verb" },
    { vi: "Äƒn", jp: "é£Ÿã¹ã‚‹", cat: "verb" },
    { vi: "uá»‘ng", jp: "é£²ã‚€", cat: "verb" },
    { vi: "mua", jp: "è²·ã†", cat: "verb" },
    { vi: "bÃ¡n", jp: "å£²ã‚‹", cat: "verb" },
    { vi: "xem", jp: "è¦‹ã‚‹", cat: "verb" },
    { vi: "nghe", jp: "èã", cat: "verb" },
    { vi: "nÃ³i", jp: "è©±ã™", cat: "verb" },
    { vi: "lÃ m", jp: "ã™ã‚‹ï¼åƒã", cat: "verb" },
    { vi: "ngá»§", jp: "å¯ã‚‹", cat: "verb" },
    { vi: "há»c", jp: "å‹‰å¼·ã™ã‚‹", cat: "verb" },
    { vi: "biáº¿t", jp: "çŸ¥ã£ã¦ã„ã‚‹", cat: "verb" },
    { vi: "hiá»ƒu", jp: "ç†è§£ã™ã‚‹", cat: "verb" },
    { vi: "cáº§n", jp: "å¿…è¦ã ", cat: "verb" },
    { vi: "muá»‘n", jp: "æ¬²ã—ã„ï¼ã€œã—ãŸã„", cat: "verb" },
    { vi: "cÃ³", jp: "ã‚ã‚‹ï¼æŒã¤", cat: "verb" },
    { vi: "khÃ´ng cÃ³", jp: "ãªã„", cat: "verb" },
    { vi: "thÃ­ch", jp: "å¥½ã", cat: "verb" },
    { vi: "ghÃ©t", jp: "å«Œã„", cat: "verb" },
    { vi: "má»Ÿ", jp: "é–‹ã‘ã‚‹", cat: "verb" },
    { vi: "Ä‘Ã³ng", jp: "é–‰ã‚ã‚‹", cat: "verb" },
    { vi: "chá»", jp: "å¾…ã¤", cat: "verb" },
    { vi: "giÃºp", jp: "åŠ©ã‘ã‚‹", cat: "verb" },
    { vi: "nhÃ ", jp: "å®¶", cat: "place" },
    { vi: "cÃ´ng ty", jp: "ä¼šç¤¾", cat: "place" },
    { vi: "cá»­a hÃ ng", jp: "åº—", cat: "place" },
    { vi: "siÃªu thá»‹", jp: "ã‚¹ãƒ¼ãƒ‘ãƒ¼", cat: "place" },
    { vi: "chá»£", jp: "å¸‚å ´", cat: "place" },
    { vi: "nhÃ  vá»‡ sinh", jp: "ãƒˆã‚¤ãƒ¬", cat: "place" },
    { vi: "bá»‡nh viá»‡n", jp: "ç—…é™¢", cat: "place" },
    { vi: "nhÃ  thuá»‘c", jp: "è–¬å±€", cat: "place" },
    { vi: "trÆ°á»ng há»c", jp: "å­¦æ ¡", cat: "place" },
    { vi: "sÃ¢n bay", jp: "ç©ºæ¸¯", cat: "place" },
    { vi: "khÃ¡ch sáº¡n", jp: "ãƒ›ãƒ†ãƒ«", cat: "place" },
    { vi: "nhÃ  hÃ ng", jp: "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³", cat: "place" },
    { vi: "quÃ¡n Äƒn", jp: "é£Ÿå ‚ï¼é£Ÿäº‹å‡¦", cat: "place" },
    { vi: "ga / nhÃ  ga", jp: "é§…", cat: "place" },
    { vi: "báº¿n xe", jp: "ãƒã‚¹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«", cat: "place" },
    { vi: "taxi", jp: "ã‚¿ã‚¯ã‚·ãƒ¼", cat: "travel" },
    { vi: "xe buÃ½t", jp: "ãƒã‚¹", cat: "travel" },
    { vi: "tÃ u", jp: "é›»è»Šï¼èˆ¹", cat: "travel" },
    { vi: "mÃ¡y bay", jp: "é£›è¡Œæ©Ÿ", cat: "travel" },
    { vi: "vÃ©", jp: "ãƒã‚±ãƒƒãƒˆ", cat: "travel" },
    { vi: "lá»‹ch trÃ¬nh", jp: "æ™‚åˆ»è¡¨ï¼äºˆå®š", cat: "travel" },
    { vi: "Ä‘i Ä‘Ã¢u?", jp: "ã©ã“ã¸è¡Œãã¾ã™ã‹ï¼Ÿ", cat: "travel" },
    { vi: "Ä‘áº¿n Ä‘Ã¢u?", jp: "ã©ã“ã«ç€ãã¾ã™ã‹ï¼Ÿ", cat: "travel" },
    { vi: "bÃªn trÃ¡i", jp: "å·¦", cat: "direction" },
    { vi: "bÃªn pháº£i", jp: "å³", cat: "direction" },
    { vi: "tháº³ng", jp: "ã¾ã£ã™ã", cat: "direction" },
    { vi: "gáº§n", jp: "è¿‘ã„", cat: "direction" },
    { vi: "xa", jp: "é ã„", cat: "direction" },
    { vi: "á»Ÿ Ä‘Ã¢u?", jp: "ã©ã“ã§ã™ã‹ï¼Ÿ", cat: "direction" },
    { vi: "hÃ´m nay", jp: "ä»Šæ—¥", cat: "time" },
    { vi: "ngÃ y mai", jp: "æ˜æ—¥", cat: "time" },
    { vi: "hÃ´m qua", jp: "æ˜¨æ—¥", cat: "time" },
    { vi: "bÃ¢y giá»", jp: "ä»Š", cat: "time" },
    { vi: "máº¥y giá»?", jp: "ä½•æ™‚ã§ã™ã‹ï¼Ÿ", cat: "time" },
    { vi: "giá»", jp: "æ™‚", cat: "time" },
    { vi: "phÃºt", jp: "åˆ†", cat: "time" },
    { vi: "sÃ¡ng", jp: "æœ", cat: "time" },
    { vi: "trÆ°a", jp: "æ˜¼", cat: "time" },
    { vi: "chiá»u", jp: "åˆå¾Œ", cat: "time" },
    { vi: "tá»‘i", jp: "å¤œ", cat: "time" },
    { vi: "bao nhiÃªu?", jp: "ã„ãã‚‰ï¼Ÿï¼ã©ã‚Œãã‚‰ã„ï¼Ÿ", cat: "money" },
    { vi: "Ä‘áº¯t", jp: "é«˜ã„", cat: "money" },
    { vi: "ráº»", jp: "å®‰ã„", cat: "money" },
    { vi: "giáº£m giÃ¡", jp: "å‰²å¼•", cat: "money" },
    { vi: "hÃ³a Ä‘Æ¡n", jp: "ãƒ¬ã‚·ãƒ¼ãƒˆï¼è«‹æ±‚æ›¸", cat: "money" },
    { vi: "tiá»n", jp: "ãŠé‡‘", cat: "money" },
    { vi: "tháº»", jp: "ã‚«ãƒ¼ãƒ‰", cat: "money" },
    { vi: "tiá»n máº·t", jp: "ç¾é‡‘", cat: "money" },
    { vi: "cÆ¡m", jp: "ã”é£¯", cat: "food" },
    { vi: "phá»Ÿ", jp: "ãƒ•ã‚©ãƒ¼", cat: "food" },
    { vi: "bÃ¡nh mÃ¬", jp: "ãƒã‚¤ãƒ³ãƒŸãƒ¼ï¼ãƒ‘ãƒ³", cat: "food" },
    { vi: "bÃºn", jp: "ãƒ–ãƒ³ï¼ˆç±³éººï¼‰", cat: "food" },
    { vi: "cÃ  phÃª", jp: "ã‚³ãƒ¼ãƒ’ãƒ¼", cat: "food" },
    { vi: "trÃ ", jp: "ãŠèŒ¶", cat: "food" },
    { vi: "bia", jp: "ãƒ“ãƒ¼ãƒ«", cat: "food" },
    { vi: "nÆ°á»›c", jp: "æ°´", cat: "food" },
    { vi: "nÆ°á»›c máº¯m", jp: "ãƒŒãƒƒã‚¯ãƒãƒ ", cat: "food" },
    { vi: "sá»¯a", jp: "ç‰›ä¹³", cat: "food" },
    { vi: "trá»©ng", jp: "åµ", cat: "food" },
    { vi: "rau", jp: "é‡èœ", cat: "food" },
    { vi: "thá»‹t", jp: "è‚‰", cat: "food" },
    { vi: "cÃ¡", jp: "é­š", cat: "food" },
    { vi: "muá»‘i", jp: "å¡©", cat: "food" },
    { vi: "Ä‘Æ°á»ng", jp: "ç ‚ç³–", cat: "food" },
    { vi: "gáº¡o", jp: "ç±³", cat: "food" },
    { vi: "Ä‘au", jp: "ç—›ã„", cat: "care" },
    { vi: "má»‡t", jp: "ç–²ã‚ŒãŸ", cat: "care" },
    { vi: "sá»‘t", jp: "ç†±", cat: "care" },
    { vi: "bÃ¡c sÄ©", jp: "åŒ»è€…", cat: "care" },
    { vi: "thuá»‘c", jp: "è–¬", cat: "care" },
    { vi: "dá»‹ á»©ng", jp: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼", cat: "care" },
    { vi: "cÃ³ thá»ƒ ~ khÃ´ng?", jp: "ã€œã§ãã¾ã™ã‹ï¼Ÿ", cat: "ask" },
    { vi: "giÃºp tÃ´i vá»›i", jp: "æ‰‹ä¼ã£ã¦ãã ã•ã„", cat: "ask" },
    { vi: "cho tÃ´i ~", jp: "ã€œã‚’ãã ã•ã„", cat: "ask" },
    { vi: "xin phÃ©p", jp: "å¤±ç¤¼ã—ã¾ã™ï¼è¨±å¯ã‚’æ±‚ã‚ã‚‹", cat: "ask" },
    { vi: "táº¡i sao?", jp: "ãªãœï¼Ÿ", cat: "ask" },
    { vi: "bá»Ÿi vÃ¬ ~", jp: "ã€œã ã‹ã‚‰", cat: "ask" },
    { vi: "Ä‘Ãºng", jp: "æ­£ã—ã„", cat: "ask" },
    { vi: "sai", jp: "é–“é•ã„", cat: "ask" },
    { vi: "gia Ä‘Ã¬nh", jp: "å®¶æ—", cat: "people" },
    { vi: "báº¡n", jp: "å‹ã ã¡", cat: "people" },
    { vi: "Ä‘á»“ng nghiá»‡p", jp: "åŒåƒš", cat: "people" },
    { vi: "sáº¿p", jp: "ä¸Šå¸", cat: "people" },
    { vi: "nhÃ¢n viÃªn", jp: "ç¤¾å“¡ï¼ã‚¹ã‚¿ãƒƒãƒ•", cat: "people" },
    { vi: "khÃ¡ch", jp: "ãŠå®¢ã•ã‚“", cat: "people" },
    { vi: "tÃ´i khÃ´ng hiá»ƒu", jp: "ã‚ã‹ã‚Šã¾ã›ã‚“", cat: "useful" },
    { vi: "nÃ³i cháº­m láº¡i", jp: "ã‚†ã£ãã‚Šè©±ã—ã¦ãã ã•ã„", cat: "useful" },
    { vi: "láº·p láº¡i Ä‘Æ°á»£c khÃ´ng?", jp: "ã‚‚ã†ä¸€åº¦è¨€ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹", cat: "useful" },
    { vi: "viáº¿t ra giÃºp tÃ´i", jp: "æ›¸ã„ã¦ãã ã•ã„", cat: "useful" },
    { vi: "tá»« nÃ y nghÄ©a lÃ  gÃ¬?", jp: "ã“ã®å˜èªã¯ã©ã†ã„ã†æ„å‘³ï¼Ÿ", cat: "useful" },
    { vi: "bao lÃ¢u?", jp: "ã©ã‚Œãã‚‰ã„ã®æ™‚é–“ï¼Ÿ", cat: "useful" },
    { vi: "khi nÃ o?", jp: "ã„ã¤ï¼Ÿ", cat: "useful" },
    { vi: "á»Ÿ Ä‘Ã¢y", jp: "ã“ã“", cat: "useful" },
    { vi: "á»Ÿ kia", jp: "ã‚ãã“", cat: "useful" },
    { vi: "táº¡i Ä‘Ã¢y", jp: "ã“ã“ã§", cat: "useful" },
    { vi: "má»™t chÃºt", jp: "å°‘ã—", cat: "useful" },
    { vi: "ráº¥t", jp: "ã¨ã¦ã‚‚", cat: "useful" },
  ];

  const LS_KEY = "vi-quiz-deck-v1";
  const LS_SETTINGS = "vi-quiz-settings-v1";
  const LS_PROGRESS = "vi-quiz-progress-v1";

  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function loadLS(key, def) {
    try { const v = JSON.parse(localStorage.getItem(key)); return v ?? def; } catch { return def; }
  }
  function saveLS(key, v) {
    try { localStorage.setItem(key, JSON.stringify(v)); } catch {}
  }
  function shuffle(a) { a = a.slice(); for (let i=a.length-1; i>0; i--) { const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function weightedSample(items, weights) { const tot = weights.reduce((s,w)=>s+w,0); let r = Math.random()*tot; for (let i=0;i<items.length;i++){ r-=weights[i]; if(r<=0) return items[i]; } return items[items.length-1]; }
  function speak(text, lang="vi-VN") { try { const u=new SpeechSynthesisUtterance(text); u.lang=lang; u.rate=1; speechSynthesis.cancel(); speechSynthesis.speak(u);} catch{} }

  // ===== State =====
  let deck = loadLS(LS_KEY, BASE_DECK);
  let settings = loadLS(LS_SETTINGS, { direction: "JPâ†’VI", selectedCats: {}, audioOn: true });
  let progress = loadLS(LS_PROGRESS, { asked: 0, correct: 0, streak: 0, history: [], wrongIds: {} });

  let cats = [];
  let activeDeck = [];
  let weights = [];

  let question = null; // {item, options:[str], prompt:str, answerIdx}
  let choice = null; // 0..3
  let revealed = false;
  let qCount = 0;

  function computeCats() {
    cats = Array.from(new Set(deck.map(d => d.cat || "misc")));
  }
  function computeActiveDeck() {
    const onCats = Object.keys(settings.selectedCats).filter(k => settings.selectedCats[k]);
    const withId = deck.map((d,i)=>({...d,_id:i}));
    activeDeck = onCats.length ? withId.filter(d => onCats.includes(d.cat || "misc")) : withId;
  }
  function computeWeights() {
    weights = activeDeck.map(d => 1 + (progress.wrongIds[d._id] || 0));
  }

  function buildQuestion() {
    if (activeDeck.length < 4) {
      $('#qCard').innerHTML = `<div class="muted">å•é¡Œã‚’æº–å‚™ä¸­â€¦ï¼ˆãƒ‡ãƒƒã‚­ã«4èªä»¥ä¸Šå¿…è¦ï¼‰</div>`;
      return;
    }
    const item = weightedSample(activeDeck, weights);
    const wrongPool = activeDeck.filter(d => d._id !== item._id);
    const distractors = shuffle(wrongPool).slice(0,3);

    const direction = settings.direction;
    const toText = (d) => direction === "JPâ†’VI" ? d.vi : d.jp;
    const promptText = direction === "JPâ†’VI" ? item.jp : item.vi;
    const opts = shuffle([item, ...distractors]);
    const answerIdx = opts.findIndex(d => d._id === item._id);

    question = { item, options: opts.map(toText), prompt: promptText, answerIdx };
    choice = null; revealed = false; qCount++;

    if (settings.audioOn && direction === "JPâ†’VI") {
      setTimeout(()=>speak(item.vi, 'vi-VN'), 200);
    }
    renderQuestion();
    renderStats();
  }

  function onAnswer(idx) {
    if (!question || revealed) return;
    const isCorrect = idx === question.answerIdx;

    // æˆç¸¾æ›´æ–°
    const wrongIds = {...progress.wrongIds};
    if (isCorrect) {
      const id = question.item._id; if (wrongIds[id]) wrongIds[id] = Math.max(0, wrongIds[id]-1);
    } else {
      const id = question.item._id; wrongIds[id] = (wrongIds[id]||0)+1;
    }
    progress = {
      asked: progress.asked + 1,
      correct: progress.correct + (isCorrect ? 1 : 0),
      streak: isCorrect ? progress.streak + 1 : 0,
      history: [{ q:{vi:question.item.vi, jp:question.item.jp}, correct:isCorrect, choiceIdx: idx, dir: settings.direction, ts: Date.now()}, ...progress.history].slice(0,200),
      wrongIds,
    };
    saveLS(LS_PROGRESS, progress);

    choice = idx; revealed = true;

    if (settings.audioOn && settings.direction === 'VIâ†’JP') {
      speak(question.item.vi, 'vi-VN');
    }
    renderQuestion();
    renderStats();
    renderReview();
  }

  function next() { buildQuestion(); }

  function resetProgress() {
    progress = { asked:0, correct:0, streak:0, history:[], wrongIds:{} };
    saveLS(LS_PROGRESS, progress);
    renderStats(); renderReview();
  }

  function exportDeck() {
    const blob = new Blob([JSON.stringify(deck, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = 'vietnamese_deck.json'; a.click();
    URL.revokeObjectURL(url);
  }

  async function importDeck(file) {
    const text = await file.text();
    try {
      const data = JSON.parse(text);
      if (Array.isArray(data)) {
        const cleaned = data.filter(x=>x&&x.vi&&x.jp).map(x=>({vi:String(x.vi).trim(), jp:String(x.jp).trim(), cat:x.cat||'user', hint:x.hint||''}));
        if (cleaned.length >= 4) { deck = cleaned; saveLS(LS_KEY, deck); afterDeckChanged(); }
        return;
      }
    } catch{}
    const lines = text.split(/\r?\n/).filter(l=>l.trim());
    const out = [];
    for (const line of lines) {
      const parts = line.includes("\t") ? line.split("\t") : line.split(",");
      if (parts.length >= 2) out.push({vi:parts[0].trim(), jp:parts[1].trim(), cat:(parts[2]||'user').trim(), hint:(parts[3]||'').trim()});
    }
    if (out.length >= 4) { deck = out; saveLS(LS_KEY, deck); afterDeckChanged(); }
  }

  function appendDeckFromText(text) {
    const lines = text.split(/\r?\n/).filter(l=>l.trim());
    const out = [];
    for (const line of lines) {
      const parts = line.includes("\t") ? line.split("\t") : line.split(",");
      if (parts.length >= 2) out.push({vi:parts[0].trim(), jp:parts[1].trim(), cat:(parts[2]||'user').trim(), hint:(parts[3]||'').trim()});
    }
    if (out.length > 0) {
      deck = [...out, ...deck]; saveLS(LS_KEY, deck); afterDeckChanged();
    }
  }

  function afterDeckChanged() {
    computeCats(); renderCats();
    computeActiveDeck(); computeWeights();
    buildQuestion(); renderReview();
  }

  // ===== Renderers =====
  function renderStats() {
    const acc = progress.asked ? Math.round(progress.correct/progress.asked*100) : 0;
    $('#statAsked').textContent = String(progress.asked);
    $('#statAcc').textContent = acc + '%';
    $('#statStreak').textContent = String(progress.streak);
  }

  function renderCats() {
    const area = $('#catArea'); area.innerHTML = '';
    if (cats.length === 0) { const d=document.createElement('div'); d.className='muted'; d.textContent='ï¼ˆãƒ‡ãƒƒã‚­ã«ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“ï¼‰'; area.appendChild(d); return; }
    for (const c of cats) {
      const label = document.createElement('label'); label.className = 'chip';
      const ck = document.createElement('input'); ck.type='checkbox'; ck.checked = !!settings.selectedCats[c]; ck.addEventListener('change', ()=>{ settings.selectedCats[c]=!settings.selectedCats[c]; saveLS(LS_SETTINGS, settings); computeActiveDeck(); computeWeights(); buildQuestion(); });
      const span = document.createElement('span'); span.textContent = c;
      label.appendChild(ck); label.appendChild(span); area.appendChild(label);
    }
  }

  function renderQuestion() {
    const wrap = $('#qCard');
    if (!question) { wrap.innerHTML = '<div class="muted">å•é¡Œã‚’æº–å‚™ä¸­â€¦</div>'; return; }
    const dirLabel = settings.direction === 'JPâ†’VI' ? 'æ—¥æœ¬èª â–¶ ãƒ™ãƒˆãƒŠãƒ èª' : 'ãƒ™ãƒˆãƒŠãƒ èª â–¶ æ—¥æœ¬èª';
    const head = `<div class="qhead"><div><div class="muted">${dirLabel}</div><div class="qprompt">${question.prompt}</div></div><div class="muted">Q${qCount}</div></div>`;

    const opts = question.options.map((opt, idx)=>{
      let cls = 'opt';
      if (revealed) cls += idx === question.answerIdx ? ' correct' : (idx === choice ? ' wrong' : '');
      return `<button class="${cls}" data-idx="${idx}"><span class="num">${idx+1}</span><span>${opt}</span></button>`;
    }).join('');

    const bottom = revealed
      ? `<div class="row" style="margin-top:10px;">
           <div>æ­£è§£ï¼š<span style="font-weight:700;">${settings.direction==='JPâ†’VI'?question.item.vi:question.item.jp}</span></div>
           ${settings.direction==='JPâ†’VI'?'<button id="speakBtn" class="btn">ğŸ”Š ç™ºéŸ³</button>':''}
           <button id="nextBtn" class="btn">æ¬¡ã¸ï¼ˆNï¼‰</button>
         </div>`
      : `<div class="row" style="margin-top:10px;"><button id="idkBtn" class="btn">ã‚ã‹ã‚‰ãªã„</button></div>`;

    wrap.innerHTML = head + `<div class="optgrid" style="margin-top:10px;">${opts}</div>` + bottom;

    $$('#qCard .opt').forEach(el => el.addEventListener('click', e => onAnswer(Number(el.dataset.idx))));
    $('#idkBtn') && $('#idkBtn').addEventListener('click', ()=>onAnswer(-1));
    $('#nextBtn') && $('#nextBtn').addEventListener('click', next);
    $('#speakBtn') && $('#speakBtn').addEventListener('click', ()=>speak(question.item.vi,'vi-VN'));
  }

  function renderReview() {
    const area = $('#reviewArea'); area.innerHTML = '';
    const pairs = Object.entries(progress.wrongIds).filter(([_,c])=>c>0).sort((a,b)=>b[1]-a[1]).slice(0,20);
    if (pairs.length === 0) { const d=document.createElement('div'); d.className='muted'; d.textContent='ã¾ã ãƒŸã‚¹ã—ãŸå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'; area.appendChild(d); return; }
    for (const [id, c] of pairs) {
      const d = deck[Number(id)]; if (!d) continue;
      const row = document.createElement('div'); row.className='card'; row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between';
      const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600;">${d.vi}</div><div class="muted">${d.jp}</div>`;
      const right = document.createElement('div'); right.className='muted'; right.textContent = `ãƒŸã‚¹ ${c}`;
      row.appendChild(left); row.appendChild(right); area.appendChild(row);
    }
  }

  // ===== Event bindings =====
  $('#direction').value = settings.direction;
  $('#direction').addEventListener('change', e=>{ settings.direction = e.target.value; saveLS(LS_SETTINGS, settings); buildQuestion(); });

  const audioBtn = $('#audioBtn');
  function renderAudioBtn() { audioBtn.textContent = settings.audioOn ? 'ğŸ”Š éŸ³å£°ON' : 'ğŸ”‡ éŸ³å£°OFF'; audioBtn.className = 'btn' + (settings.audioOn ? ' on' : ''); }
  renderAudioBtn();
  audioBtn.addEventListener('click', ()=>{ settings.audioOn = !settings.audioOn; saveLS(LS_SETTINGS, settings); renderAudioBtn(); });

  $('#exportBtn').addEventListener('click', exportDeck);
  $('#importBtn').addEventListener('click', ()=>$('#fileInput').click());
  $('#fileInput').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if (f) importDeck(f); e.target.value=''; });

  $('#appendBtn').addEventListener('click', ()=>{ const t=$('#appendText').value; if (t.trim()) { appendDeckFromText(t); $('#appendText').value=''; }});
  $('#resetBtn').addEventListener('click', resetProgress);
  $('#refreshBtn').addEventListener('click', buildQuestion);

  window.addEventListener('keydown', (e)=>{
    if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
    if (e.key>='1' && e.key<='4') onAnswer(parseInt(e.key,10)-1);
    else if (e.key.toLowerCase()==='n') { if (revealed) next(); }
    else if (e.key.toLowerCase()==='s') { if (question) speak(question.item.vi,'vi-VN'); }
    else if (e.key.toLowerCase()==='i') { if (!revealed) onAnswer(-1); }
  });

  // ===== Init =====
  computeCats(); renderCats();
  computeActiveDeck(); computeWeights();
  renderStats(); renderReview();
  buildQuestion();
  </script>
</body>
</html>
